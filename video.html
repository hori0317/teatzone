<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å½±éŸ³å­¸ç¿’å€ï½œé•·ç…§å·¥å…·</title>
  <link rel="icon" type="image/x-icon" href="YORU.ico" />
  <link rel="stylesheet" href="style.css" />
  
  <style>
    .video-card { text-align: center; margin-bottom: 20px; max-width: 100%; margin: 0 auto; }
    .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; background: #000; margin: 0 auto; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    .video-mask-top { position: absolute; top: 0; left: 0; width: 100%; height: 80px; background: transparent; z-index: 10; cursor: default; }
    .video-mask-logo { position: absolute; bottom: 0; right: 0; width: 120px; height: 50px; background: transparent; z-index: 10; cursor: default; }
    .login-warning-box { padding: 40px 20px; background: #f5f5f5; border: 2px dashed #ccc; border-radius: 12px; color: #666; font-weight: 700; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(47,47,32,0.6); backdrop-filter: blur(3px); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px; }
    .modal-content { background: #fffdf5; border: 1px solid #e6dca8; border-radius: 12px; padding: 24px; width: 100%; max-width: 420px; text-align: center; }
    .modal-content h3 { color: #2e7d32; margin-top: 0; }
    .modal-content input { width: 100%; padding: 10px; margin-top: 4px; border: 1px solid #e6dca8; } 
    .modal-actions { margin-top: 20px; }
  </style>
  <script src="nav.js" defer></script>
</head>
<body data-page="video">

  <header class="topbar">
    <div class="brand">
      <a href="index.html" class="logo-link"><img src="org-logo.png" alt="logo" onerror="this.style.opacity=0.2" /></a>
      <span class="site-title" data-sync-title>å½±éŸ³å­¸ç¿’å€</span>
    </div>
    
    <nav class="nav-links" aria-label="ä¸»é¸å–®">
      <a href="calculator.html">é¡åº¦è¨ˆç®—æ©Ÿ</a>
      <a href="payroll.html">è–ªè³‡è¨ˆç®—æ©Ÿ</a>
      <a href="video.html">å½±éŸ³å°ˆå€</a>
      <a href="care-info.html">é•·ç…§è³‡è¨Š</a>
      <a href="news.html">æœ€æ–°å…¬å‘Š</a>
      <a href="contact.html">è¯ç¹«æ–¹å¼</a>
      <a href="about.html">é—œæ–¼æˆ‘å€‘</a>
    </nav>
    
    <div class="actions" style="align-items: center; gap: 8px;">
        <button class="btn pill" style="background:#4285F4; color:white;" id="btnLogin" type="button">Google ç™»å…¥</button>
        <div id="member-area" style="display:none; align-items: center; gap:5px;">
            <span id="userDisplay" style="font-size: 13px; font-weight: bold; color: #333; margin-right: 4px;"></span>
            <a href="admin.html" id="btnAdminLink" class="btn pill" style="background:#673AB7; color:white; font-size:12px; padding:4px 10px; text-decoration:none; display:none;">ç®¡ç†å¾Œå°</a>
            <button class="btn pill" style="background:#777; color:white; font-size:12px; padding:4px 10px;" id="btnEditProfile" type="button">ä¿®æ”¹è³‡æ–™</button>
            <button class="btn pill" style="background:#EA4335; color:white;" id="btnLogout" type="button">ç™»å‡º</button>
        </div>
    </div>
  </header>
  <div class="divider"></div>

  <main class="container">
    <section class="card video-card">
        <h2 class="card-title">ğŸ¥ å­¸ç¿’å½±ç‰‡ï¼šé•·ç…§æœå‹™ä»‹ç´¹</h2>
        
        <div id="login-warning" class="login-warning-box">
            ğŸ”’ è«‹å…ˆç™»å…¥æœƒå“¡ä»¥è§€çœ‹æ•™å­¸å½±ç‰‡ä¸¦ç´¯ç©æ™‚æ•¸
        </div>
    
        <div id="video-wrapper" style="display:none;">
            <div class="video-container">
                <div id="video-placeholder"></div>
                <div class="video-mask-top"></div>
                <div class="video-mask-logo"></div>
            </div>
            
            <p class="hint" style="margin-top:12px; font-size:15px;">
                ç´¯ç©è§€çœ‹ï¼š<span id="watchTimeDisplay" style="color:#2e7d32; font-weight:bold; font-size:18px;">0</span> ç§’
                <span id="saveStatus" style="font-size:13px; color:#999; margin-left:8px;"></span>
            </p>
        </div>
    </section>
  </main>

  <footer id="bottomDock" class="footerbar">
    <div class="foot"><span class="ok">Â© hori é•·ç…§å·¥å…·å¹³å°</span></div>
  </footer>

  <div id="profile-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <h3>æ­¡è¿åŠ å…¥ï¼è«‹å®Œå–„è³‡æ–™</h3>
      <p>å¡«å¯«æ‚¨çš„åŸºæœ¬è³‡è¨Šã€‚</p>
      <div style="text-align:left; margin-bottom:12px;">
        <label style="font-weight:700; color:var(--ink); font-size:15px;">å§“å / ç¨±å‘¼</label>
        <input type="text" id="pf-name" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">
      </div>
      <div style="text-align:left; margin-bottom:12px;">
        <label style="font-weight:700; color:var(--ink); font-size:15px;">ä½¿ç”¨è€…å¹´é½¡</label>
        <input type="number" id="pf-age" placeholder="ä¾‹å¦‚ï¼š65">
      </div>
      <div class="modal-actions">
        <button id="btn-save-profile" class="btn pill btn-green" style="width:100%; font-size:16px; padding:10px;">
          å„²å­˜ä¸¦é–‹å§‹ä½¿ç”¨
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, signOut, onAuthStateChanged, GoogleAuthProvider } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const config = { apiKey: "AIzaSyCZMhdUI0HeIoj5masuRh00pzP3SMbF6Yc", authDomain: "hori-test-1b93c.firebaseapp.com", projectId: "hori-test-1b93c", storageBucket: "hori-test-1b93c.firebasestorage.app", messagingSenderId: "549583061796", appId: "1:549583061796:web:ad58b8bf80c2b6b71c29b1" };
    const app=initializeApp(config), auth=getAuth(app), db=getFirestore(app), provider=new GoogleAuthProvider();

    const dom={ login:document.getElementById('btnLogin'), logout:document.getElementById('btnLogout'), member:document.getElementById('member-area'), user:document.getElementById('userDisplay'), admin:document.getElementById('btnAdminLink'), edit:document.getElementById('btnEditProfile'), modal:document.getElementById('profile-modal'), save:document.getElementById('btn-save-profile'), name:document.getElementById('pf-name'), age:document.getElementById('pf-age'), title:document.querySelector('#profile-modal h3'), video:document.getElementById('video-wrapper'), warn:document.getElementById('login-warning'), status:document.getElementById('saveStatus'), watch:document.getElementById('watchTimeDisplay') };

    const YOUTUBE_VIDEO_ID = 'PLG2Uexyi9s'; 
    let currentUser=null, player, timer, currentSec=0, totalSec=0;

    const tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
    window.onYouTubeIframeAPIReady = function() {
      player = new YT.Player('video-placeholder', {
        videoId: YOUTUBE_VIDEO_ID, playerVars: { 'playsinline':1, 'modestbranding':1, 'rel':0, 'controls':1, 'fs':0, 'iv_load_policy':3 },
        events: { 'onStateChange': onPlayerStateChange }
      });
    };
    function onPlayerStateChange(e){ if(e.data==1) startT(); else stopT(); }
    
    function startT(){ 
        if(!currentUser)return; 
        if(timer) clearInterval(timer); 
        timer=setInterval(()=>{ 
            currentSec++; 
            totalSec++; 
            if(dom.watch) dom.watch.textContent=totalSec; 
            if(currentSec >= 10) save(); // æ¯ç´¯ç©10ç§’å­˜ä¸€æ¬¡
        }, 1000); 
    }
    
    function stopT(){ if(timer){ clearInterval(timer); timer=null; } save(); }

    async function save(){ 
        if(!currentUser || currentSec === 0) return;
        const addedSec = currentSec; // ç´€éŒ„æœ¬æ¬¡è¦å¢åŠ çš„ç§’æ•¸
        currentSec = 0; // ç«‹å³é‡è¨­ï¼Œé¿å…é‡è¤‡è¨ˆç®—
        
        if(dom.status) dom.status.textContent="åŒæ­¥ä¸­...";
        try{ 
            // 1. æ›´æ–°è©³ç´°å½±ç‰‡æ—¥èªŒ
            await setDoc(doc(db,"video_logs",currentUser.uid+"_"+YOUTUBE_VIDEO_ID), { 
                uid:currentUser.uid, 
                email:currentUser.email, 
                videoId:YOUTUBE_VIDEO_ID, 
                videoTitle:"æ•™å­¸å½±ç‰‡", 
                lastWatched:serverTimestamp(), 
                totalSeconds:totalSec 
            }, {merge:true}); 

            // 2. åŒæ­¥å¢åŠ ä½¿ç”¨è€…è³‡æ–™è¡¨ä¸­çš„ç¸½è§€çœ‹æ™‚é–“ (é‡é»ä¿®æ”¹)
            await updateDoc(doc(db, "users", currentUser.uid), {
                totalWatchTime: increment(addedSec)
            });

            if(dom.status){ dom.status.textContent="å·²åŒæ­¥"; setTimeout(()=>dom.status.textContent="",2000); }
        }catch(e){ console.error("Save error:", e); } 
    }

    async function loadHist(u){ try{ const s=await getDoc(doc(db,"video_logs",u.uid+"_"+YOUTUBE_VIDEO_ID)); if(s.exists()) totalSec=s.data().totalSeconds||0; if(dom.watch) dom.watch.textContent=totalSec; }catch(e){} }

    dom.login.addEventListener('click',()=>signInWithPopup(auth,provider).catch(e=>alert(e.code==='auth/popup-blocked'?"è«‹ç”¨ç€è¦½å™¨é–‹å•Ÿ":e.message)));
    dom.logout.addEventListener('click',()=>signOut(auth).then(()=>{stopT();if(player&&player.pauseVideo)player.pauseVideo();location.reload()}));

    onAuthStateChanged(auth, async u=>{
      if(u){
        currentUser=u; dom.login.style.display='none'; dom.warn.style.display='none'; dom.video.style.display='block'; dom.member.style.display='flex'; dom.user.textContent=u.displayName||u.email; loadHist(u);
        try{ const s=await getDoc(doc(db,"users",u.uid)); if(s.exists()){ if(s.data().name) dom.user.textContent=s.data().name; } else { dom.title.textContent="æ­¡è¿"; dom.name.value=u.displayName||""; dom.modal.style.display='flex'; } }catch(e){}
        try{ const a=await getDoc(doc(db,"admins",u.email)); if(a.exists()) dom.admin.style.display='inline-block'; }catch(e){}
      }else{ currentUser=null; dom.login.style.display='block'; dom.member.style.display='none'; dom.warn.style.display='block'; dom.video.style.display='none'; }
    });

    dom.edit.addEventListener('click',async()=>{ const s=await getDoc(doc(db,"users",currentUser.uid)); if(s.exists()){ const d=s.data(); dom.title.textContent="ä¿®æ”¹"; dom.name.value=d.name||""; dom.age.value=d.age||""; dom.modal.style.display='flex'; } });
    dom.save.addEventListener('click',async()=>{
        const n=dom.name.value, a=dom.age.value; if(!n||!a) return alert("å¡«å¯«å®Œæ•´");
        const ref=doc(db,"users",currentUser.uid); const s=await getDoc(ref);
        let d={name:n,age:a,email:currentUser.email,lastUpdated:serverTimestamp()};
        if(!s.exists()||!s.data().createdAt) d.createdAt=serverTimestamp();
        await setDoc(ref,d,{merge:true}); alert("å·²å„²å­˜"); dom.modal.style.display='none'; dom.user.textContent=n;
    });
    
    dom.modal.addEventListener('click',e=>{if(e.target===dom.modal&&currentUser&&dom.user.textContent!="")dom.modal.style.display='none'});
  </script>
</body>
</html>
