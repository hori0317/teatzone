<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å½±éŸ³å­¸ç¿’å€ï½œé•·ç…§å·¥å…·</title>
  <link rel="icon" type="image/x-icon" href="YORU.ico" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .video-card { text-align: center; margin-bottom: 20px; max-width: 100%; margin: 0 auto; }
    .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; background: #000; margin: 0 auto; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    .video-mask-top { position: absolute; top: 0; left: 0; width: 100%; height: 80px; background: transparent; z-index: 10; cursor: default; }
    .video-mask-logo { position: absolute; bottom: 0; right: 0; width: 120px; height: 50px; background: transparent; z-index: 10; cursor: default; }
    .login-warning-box { padding: 40px 20px; background: #f5f5f5; border: 2px dashed #ccc; border-radius: 12px; color: #666; font-weight: 700; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(47,47,32,0.6); backdrop-filter: blur(3px); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px; }
    .modal-content { background: #fffdf5; border: 1px solid #e6dca8; border-radius: 12px; padding: 24px; width: 100%; max-width: 420px; text-align: center; }
    .modal-content h3 { color: #2e7d32; margin-top: 0; }
    .modal-content input { width: 100%; padding: 10px; margin-top: 4px; border: 1px solid #e6dca8; } 
    .modal-actions { margin-top: 20px; }
  </style>
  <script src="nav.js" defer></script>
</head>
<body data-page="video">

  <header class="topbar">
    <div class="brand">
      <a href="index.html" class="logo-link"><img src="org-logo.png" alt="logo" onerror="this.style.opacity=0.2" /></a>
      <span class="site-title" data-sync-title>å½±éŸ³å­¸ç¿’å€</span>
    </div>
    
    <nav class="nav-links">
      <a href="calculator.html">é¡åº¦è¨ˆç®—æ©Ÿ</a>
      <a href="payroll.html">è–ªè³‡è¨ˆç®—æ©Ÿ</a>
      <a href="video.html">å½±éŸ³å°ˆå€</a>
      <a href="care-info.html">é•·ç…§è³‡è¨Š</a>
      <a href="news.html">æœ€æ–°å…¬å‘Š</a>
      <a href="contact.html">è¯ç¹«æ–¹å¼</a>
      <a href="about.html">é—œæ–¼æˆ‘å€‘</a>
    </nav>
    
    <div class="actions" style="align-items: center; gap: 8px;">
        <button class="btn pill" style="background:#4285F4; color:white;" id="btnLogin">Google ç™»å…¥</button>
        <div id="member-area" style="display:none; align-items: center; gap:5px;">
            <span id="userDisplay" style="font-size: 13px; font-weight: bold; color: #333;"></span>
            <a href="admin.html" id="btnAdminLink" class="btn pill" style="background:#673AB7; color:white; font-size:12px; display:none;">ç®¡ç†å¾Œå°</a>
            <button class="btn pill" style="background:#777; color:white; font-size:12px;" id="btnEditProfile">ä¿®æ”¹è³‡æ–™</button>
            <button class="btn pill" style="background:#EA4335; color:white;" id="btnLogout">ç™»å‡º</button>
        </div>
    </div>
  </header>

  <main class="container">
    <section class="card video-card">
        <h2 class="card-title">ğŸ¥ å­¸ç¿’å½±ç‰‡ï¼šé•·ç…§æœå‹™ä»‹ç´¹</h2>
        <div id="login-warning" class="login-warning-box">ğŸ”’ è«‹å…ˆç™»å…¥æœƒå“¡ä»¥ç´¯ç©å­¸ç¿’æ™‚æ•¸</div>
    
        <div id="video-wrapper" style="display:none;">
            <div class="video-container">
                <div id="video-placeholder"></div>
                <div class="video-mask-top"></div>
                <div class="video-mask-logo"></div>
            </div>
            <p class="hint" style="margin-top:12px; font-size:15px;">
                æ‚¨çš„ç¸½å­¸ç¿’æ™‚æ•¸ï¼š<span id="watchTimeDisplay" style="color:#2e7d32; font-weight:bold; font-size:18px;">0</span> ç§’
                <span id="saveStatus" style="font-size:13px; color:#999; margin-left:8px;"></span>
            </p>
        </div>
    </section>
  </main>

  <!-- Profile Modal (ç•¥ï¼ŒåŒå‰) -->
  <div id="profile-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <h3>æ­¡è¿åŠ å…¥ï¼è«‹å®Œå–„è³‡æ–™</h3>
      <div style="text-align:left; margin-bottom:12px;">
        <label>å§“å / ç¨±å‘¼</label>
        <input type="text" id="pf-name">
      </div>
      <div style="text-align:left; margin-bottom:12px;">
        <label>ä½¿ç”¨è€…å¹´é½¡</label>
        <input type="number" id="pf-age">
      </div>
      <button id="btn-save-profile" class="btn pill btn-green" style="width:100%;">å„²å­˜ä¸¦é–‹å§‹ä½¿ç”¨</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, signOut, onAuthStateChanged, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const config = { apiKey: "AIzaSyCZMhdUI0HeIoj5masuRh00pzP3SMbF6Yc", authDomain: "hori-test-1b93c.firebaseapp.com", projectId: "hori-test-1b93c", storageBucket: "hori-test-1b93c.firebasestorage.app", messagingSenderId: "549583061796", appId: "1:549583061796:web:ad58b8bf80c2b6b71c29b1" };
    const app=initializeApp(config), auth=getAuth(app), db=getFirestore(app), provider=new GoogleAuthProvider();

    const dom={ login:document.getElementById('btnLogin'), logout:document.getElementById('btnLogout'), member:document.getElementById('member-area'), user:document.getElementById('userDisplay'), admin:document.getElementById('btnAdminLink'), edit:document.getElementById('btnEditProfile'), modal:document.getElementById('profile-modal'), save:document.getElementById('btn-save-profile'), name:document.getElementById('pf-name'), age:document.getElementById('pf-age'), title:document.querySelector('#profile-modal h3'), video:document.getElementById('video-wrapper'), warn:document.getElementById('login-warning'), status:document.getElementById('saveStatus'), watch:document.getElementById('watchTimeDisplay') };

    const YOUTUBE_VIDEO_ID = 'PLG2Uexyi9s'; 
    let currentUser=null, player, timer, currentSec=0, baseTotalSec=0;

    // YouTube API
    const tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
    window.onYouTubeIframeAPIReady = function() {
      player = new YT.Player('video-placeholder', {
        videoId: YOUTUBE_VIDEO_ID, playerVars: { 'playsinline':1, 'modestbranding':1, 'rel':0, 'controls':1, 'fs':0, 'iv_load_policy':3 },
        events: { 'onStateChange': onPlayerStateChange }
      });
    };

    function onPlayerStateChange(e){ if(e.data==1) startT(); else stopT(); }
    
    function startT(){ 
        if(!currentUser)return; 
        if(timer) clearInterval(timer); 
        timer=setInterval(()=>{ 
            currentSec++; 
            // é¡¯ç¤º = è³‡æ–™åº«åŸæœ¬çš„ç¸½é‡ + æœ¬æ¬¡é–‹å•Ÿé é¢å¾Œçœ‹çš„é‡
            if(dom.watch) dom.watch.textContent = baseTotalSec + currentSec; 
            if(currentSec >= 10) save(); 
        }, 1000); 
    }
    
    function stopT(){ if(timer){ clearInterval(timer); timer=null; } save(); }

    async function save(){ 
        if(!currentUser || currentSec === 0) return;
        const addedSec = currentSec; 
        currentSec = 0; // ç«‹å³æ­¸é›¶é¿å…é‡è¤‡è¨ˆç®—
        
        if(dom.status) dom.status.textContent="åŒæ­¥ä¸­...";
        try{ 
            // 1. æ›´æ–°ä½¿ç”¨è€…ç¸½æ™‚æ•¸ (é€™æ˜¯å¾Œå°è®€å–çš„ä¾†æº)
            const userRef = doc(db, "users", currentUser.uid);
            await updateDoc(userRef, {
                totalWatchTime: increment(addedSec),
                lastActive: serverTimestamp()
            });

            // 2. åŒæ­¥æ›´æ–°æœ¬åœ°åŸºæº–å€¼ï¼Œç¢ºä¿ UI é¡¯ç¤ºé€£çºŒ
            baseTotalSec += addedSec;

            // 3. å¦å¤–å­˜ä¸€ä»½è©³ç´°æ—¥èªŒ (é¸ç”¨)
            setDoc(doc(db,"video_logs",currentUser.uid+"_"+YOUTUBE_VIDEO_ID), { 
                lastWatched:serverTimestamp(), 
                totalSeconds: baseTotalSec // æ›´æ–°é€™å€‹ç‰¹å®šå½±ç‰‡çœ‹çš„é€²åº¦
            }, {merge:true}); 

            if(dom.status){ dom.status.textContent="å·²åŒæ­¥"; setTimeout(()=>dom.status.textContent="",2000); }
        }catch(e){ console.error(e); } 
    }

    // é—œéµä¿®æ­£ï¼šåˆå§‹åŒ–æ™‚å¾ users è®€å–ç¸½æ™‚æ•¸
    async function loadHist(u){ 
        try{ 
            const s = await getDoc(doc(db, "users", u.uid)); 
            if(s.exists()){
                baseTotalSec = s.data().totalWatchTime || 0;
            } else {
                baseTotalSec = 0;
            }
            if(dom.watch) dom.watch.textContent = baseTotalSec; 
        }catch(e){ console.error(e); } 
    }

    dom.login.addEventListener('click',()=>signInWithPopup(auth,provider));
    dom.logout.addEventListener('click',()=>signOut(auth).then(()=>location.reload()));

    onAuthStateChanged(auth, async u=>{
      if(u){
        currentUser=u; dom.login.style.display='none'; dom.warn.style.display='none'; dom.video.style.display='block'; dom.member.style.display='flex'; dom.user.textContent=u.displayName||u.email; 
        await loadHist(u); // å…ˆè®€å–æ­·å²æ™‚æ•¸
        try{ 
            const s=await getDoc(doc(db,"users",u.uid)); 
            if(!s.exists()){ dom.modal.style.display='flex'; } 
            else if(s.data().name) dom.user.textContent=s.data().name;
            const a=await getDoc(doc(db,"admins",u.email)); if(a.exists()) dom.admin.style.display='inline-block';
        }catch(e){}
      }else{ dom.login.style.display='block'; dom.member.style.display='none'; dom.warn.style.display='block'; dom.video.style.display='none'; }
    });

    dom.save.addEventListener('click',async()=>{
        const n=dom.name.value, a=dom.age.value; if(!n||!a) return alert("å¡«å¯«å®Œæ•´");
        await setDoc(doc(db,"users",currentUser.uid),{name:n,age:a,email:currentUser.email,totalWatchTime:0,createdAt:serverTimestamp()},{merge:true});
        dom.modal.style.display='none'; dom.user.textContent=n;
    });
  </script>
</body>
</html>
