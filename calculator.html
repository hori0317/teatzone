<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é¡åº¦è¨ˆç®—æ©Ÿï½œé•·ç…§å·¥å…·</title>
  <meta name="description" content="é•·ç…§æœå‹™é¡åº¦è¨ˆç®—æ©Ÿï¼Œå¿«é€ŸæŸ¥è©¢CMSç­‰ç´šè£œåŠ©é¡åº¦ã€è¨ˆç®—è‡ªä»˜é‡‘é¡èˆ‡å±…æœè–ªè³‡ã€‚ç”± hori è£½ä½œã€‚">
  <link rel="icon" type="image/x-icon" href="YORU.ico" />
  <link rel="stylesheet" href="style.css" />
  
  <script>
    /* ç«‹å³æª¢æŸ¥ä¸»é¡Œè¨­å®šï¼Œé˜²æ­¢é é¢é–ƒçˆ */
    (function() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
    })();
  </script>
  
  <script src="nav.js" defer></script>
  <script src="script.js" defer></script>

  <style>
    /* åŸç‰ˆæ’ç‰ˆï¼šä¿ç•™ grid-2 èˆ‡å¯¬åº¦å¾®èª¿ */
    .grid-2{
      display: grid;
      grid-template-columns: 2.2fr 1.3fr;
      gap: 16px; 
      align-items: start;
    }
    @media (max-width: 1024px){ .grid-2{ grid-template-columns: 1.8fr 1.2fr; } }
    @media (max-width: 860px){ .grid-2{ grid-template-columns: 1fr; } }
    
    #addonPlaceholders{ display:none; }

    /* æœƒå“¡å½ˆçª—æ¨£å¼ - å¼•ç”¨è®Šæ•¸æ”¯æ´æ·±è‰²æ¨¡å¼ */
    .modal-overlay { 
        position: fixed; 
        top: 0; left: 0; 
        width: 100%; height: 100%; 
        background: rgba(47,47,32,0.6); 
        backdrop-filter: blur(3px); 
        z-index: 2000; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        padding: 20px; 
    }
    .modal-content { 
        background: var(--card); 
        border: 1px solid var(--line); 
        border-radius: 12px; 
        padding: 24px; 
        width: 100%; 
        max-width: 420px; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
        text-align: center; 
        color: var(--ink);
    }
    .modal-content h3 { color: var(--green); margin-top: 0; }
    .modal-content input { 
        width: 100%; 
        padding: 10px; 
        border: 1px solid var(--line); 
        background: var(--input-bg); 
        color: var(--ink);
        border-radius: 8px; 
        font-size: 16px; 
        margin-top: 4px; 
        box-sizing: border-box; 
    }
    .modal-actions { margin-top: 20px; }

    /* é‡å°æ·±è‰²æŒ‰éˆ•åœ¨å·¦å´çš„å¾®èª¿æ¨£å¼ */
    .brand .theme-btn {
        margin-left: 15px; /* èˆ‡æ¨™é¡Œä¿æŒè·é›¢ */
        height: 32px;      /* ç¨å¾®ç¸®å°ä»¥é…åˆæ¨™é¡Œé«˜åº¦ */
        padding: 0 12px;
        font-size: 13px;
    }
    @media (max-width: 1180px) {
        .brand .theme-btn { margin-left: 10px; }
    }
  </style>
</head>
<body data-page="calculator"> 
  
  <!-- æµ®æ°´å° (å®Œæ•´ä¿ç•™) -->
  <div class="watermark" aria-hidden="true">
    <span class="wm-item" style="top:5%; left:5%;  --dur:9s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:5%; left:35%; --dur:11s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:5%; left:65%; --dur:10s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:25%; left:10%; --dur:13s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:25%; left:40%; --dur:12s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:25%; left:70%; --dur:14s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:50%; left:5%;  --dur:10s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:50%; left:35%; --dur:11s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:50%; left:65%; --dur:9s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:75%; left:10%; --dur:13s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:75%; left:40%; --dur:12s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:75%; left:70%; --dur:10s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:90%; left:15%; --dur:11s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:90%; left:45%; --dur:10s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
    <span class="wm-item" style="top:90%; left:75%; --dur:12s;">@horiç‰ˆæ¬Šæ‰€æœ‰</span>
  </div>

  <header class="topbar">
    <div class="brand">
      <a href="index.html" class="logo-link"><img src="org-logo.png" alt="logo" onerror="this.style.opacity=0.2" /></a>
      <span class="site-title" id="siteTitle" data-sync-title>é¡åº¦è¨ˆç®—æ©Ÿ</span>
      
      <!-- æ·±è‰²æ¨¡å¼åˆ‡æ›æŒ‰éˆ• (å·²å¾ Actions ç§»è‡³æ­¤è™•) -->
      <button id="darkToggle" class="theme-btn">
          <span class="icon">ğŸŒ™</span> <span class="txt">æ·±è‰²</span>
      </button>
    </div>
    
    <nav class="nav-links" aria-label="ä¸»é¸å–®">
      <a href="calculator.html">é¡åº¦è¨ˆç®—æ©Ÿ</a>
      <a href="payroll.html">è–ªè³‡è¨ˆç®—æ©Ÿ</a>
      <a href="video.html">å½±éŸ³å°ˆå€</a>
      <a href="care-info.html">é•·ç…§è³‡è¨Š</a>
      <a href="news.html">æœ€æ–°å…¬å‘Š</a>
      <a href="contact.html">è¯ç¹«æ–¹å¼</a>
      <a href="about.html">é—œæ–¼æˆ‘å€‘</a>
    </nav>
    
    <!-- å³å´æŒ‰éˆ•å€ (ç¾åœ¨ç©ºé–“è®Šå¯¬è£•äº†) -->
    <div class="actions" style="display:flex; align-items:center; gap:8px;">
      <button class="btn pill btn-orange" id="btnUnitToggle" type="button" data-unit="B">Bå–®ä½</button>
      <button class="btn pill btn-green" id="btnReset" type="button">é‡ç½®</button>
      <button class="btn pill btn-gray" id="btnPrint" type="button" onclick="window.print()">åˆ—å°</button>
      
      <div style="width: 1px; height: 20px; background: var(--line); margin: 0 4px;"></div>
      
      <button class="btn pill" style="background:#4285F4; color:white;" id="btnLogin" type="button">Google ç™»å…¥</button>
      
      <div id="member-area" style="display:none; align-items: center; gap:5px;">
          <span id="userDisplay" style="font-size: 13px; font-weight: bold; color: var(--ink); margin-right: 4px;"></span>
          <a href="admin.html" id="btnAdminLink" class="btn pill" style="display:none;background:#673AB7;color:white;font-size:12px;padding:4px 10px;text-decoration:none">å¾Œå°</a>
          <button class="btn pill" style="background:#777; color:white; font-size:12px; padding:4px 10px;" id="btnEditProfile" type="button">ä¿®æ”¹</button>
          <button class="btn pill" style="background:#34A853; color:white;" id="btnSaveCloud" type="button">å„²å­˜</button>
          <button class="btn pill" style="background:#EA4335; color:white;" id="btnLogout" type="button">ç™»å‡º</button>
      </div>
    </div>
  </header>
  <div class="divider"></div>

  <main class="container">
    <section class="grid-2">
      <div class="card">
        <h2 class="card-title">åŸºæœ¬è³‡æ–™</h2>
        <div class="form-row">
          <label>èº«åˆ†é¡åˆ¥ï¼š</label>
          <div class="chips">
            <label class="chip"><input type="radio" name="idty" value="ä¸€èˆ¬æˆ¶" checked> ä¸€èˆ¬æˆ¶</label>
            <label class="chip"><input type="radio" name="idty" value="ä¸­ä½æ”¶å…¥æˆ¶"> ä¸­ä½æ”¶</label>
            <label class="chip"><input type="radio" name="idty" value="ä½æ”¶å…¥æˆ¶"> ä½æ”¶</label>
          </div>
        </div>

        <div class="form-row">
          <label>CMS ç­‰ç´šï¼š</label>
          <div class="cms">
            <label><input type="radio" name="cms" value="2" checked><span>2</span></label>
            <label><input type="radio" name="cms" value="3"><span>3</span></label>
            <label><input type="radio" name="cms" value="4"><span>4</span></label>
            <label><input type="radio" name="cms" value="5"><span>5</span></label>
            <label><input type="radio" name="cms" value="6"><span>6</span></label>
            <label><input type="radio" name="cms" value="7"><span>7</span></label>
            <label><input type="radio" name="cms" value="8"><span>8</span></label>
          </div>
        </div>

        <div class="form-row"><label>ç•™ç”¨é¡åº¦ï¼š</label><input id="keepQuota" type="number" min="0" style="background:var(--input-bg); color:var(--ink); border:1px solid var(--line); border-radius:6px; padding:4px 8px;"/></div>
        <div class="form-row"><label>çµ¦ä»˜é¡åº¦ï¼š</label><input id="grantQuota" type="text" readonly style="background:var(--table-stripe); color:var(--ink); border:1px solid var(--line); border-radius:6px; padding:4px 8px;"/></div>

        <div class="form-row">
          <label>æ˜¯å¦æœ‰å¤–ç±çœ‹è­·ï¼š</label>
          <div class="chips">
            <label class="chip"><input type="radio" name="foreign" value="1"> æœ‰</label>
            <label class="chip"><input type="radio" name="foreign" value="0" checked> ç„¡</label>
          </div>
        </div>
        <div id="warnSCfg" class="note warn">æœªå‹¾é¸å¤–ç±çœ‹è­·ï¼ŒSC ç›®å‰ä¸å¯ç”¨ã€‚</div>

        <div class="qrbox">
          <div class="qr-left"><img src="qrcode.png" alt="QR" onerror="this.style.opacity=0.2" /></div>
          <div class="qr-right">
            <p class="bold">æˆ‘å€‘æ˜¯XXå±…å®¶é•·ç…§æ©Ÿæ§‹</p>
            <p>è² è²¬å€åŸŸç‚º XXXXXX<br>æ­¡è¿æ´½è©¢ï¼š</p>
            <p>è«®è©¢é›»è©±ï¼š02-XXXX-XXXX</p>
            <p class="orange">å»£å‘Šå¾…è£œ</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 class="card-title">å€‹æ¡ˆé¡åº¦åŠè‡ªä»˜é¡</h2>
        <div class="kv">
          <div class="kv-row"><span>é¡åº¦ç¸½è¨ˆï¼š</span><b id="sumGrantBA">0</b></div>
          <div class="kv-row"><span>å‰©é¤˜é¡åº¦ï¼š</span><b id="sumRemainBA">0</b></div>
          <div id="overMain" class="note warn hidden">å·²è¶…é BA é¡åº¦</div>
          <hr style="border: 0; border-top: 1px dashed var(--line); margin: 10px 0;">
          <div class="kv-row"><span>GA é¡åº¦ï¼š</span><b id="sumGrantGA">0</b></div>
          <div class="kv-row"><span>å‰©é¤˜é¡åº¦ï¼š</span><b id="sumRemainGA">0</b></div>
          <div id="overGA" class="note warn hidden">å·²è¶…é GA é¡åº¦</div>
          <hr style="border: 0; border-top: 1px dashed var(--line); margin: 10px 0;">
          <div class="kv-row"><span>SC é¡åº¦ï¼š</span><b id="sumGrantSC">0</b></div>
          <div class="kv-row"><span>å‰©é¤˜é¡åº¦ï¼š</span><b id="sumRemainSC">0</b></div>
          <div id="overSC" class="note warn hidden">å·²è¶…é SC é¡åº¦</div>
          <hr style="border: 0; border-top: 1px dashed var(--line); margin: 10px 0;">
          <div class="kv-row"><span>éƒ¨åˆ†è² æ“”ï¼š</span><b id="sumCopay">0</b></div>
          <div class="kv-row"><span>è‡ªä»˜ç¸½è¨ˆï¼š</span><b id="sumSelfpay">0</b></div>
          <div class="kv-row optional"><span>æ”¿åºœè£œåŠ©ï¼š</span><b id="sumGovSubsidy">0</b></div>
          <div class="kv-row optional"><span>ç¸½é‡‘é¡ï¼š</span><b id="sumGrand">0</b></div>
        </div>
      </div>
    </section>

    <section class="card service-card">
      <h2 class="card-title">æœå‹™é …ç›®</h2>
      <div id="tables"></div>
    </section>
  </main>

  <footer id="bottomDock" class="footerbar">
    <div class="foot">
      <span>BA å‰©é¤˜ï¼š<b id="sumRemainBA_foot">0</b></span>
      <span>GA å‰©é¤˜ï¼š<b id="sumRemainGA_foot">0</b></span>
      <span>SC å‰©é¤˜ï¼š<b id="sumRemainSC_foot">0</b></span>
      <span class="ok">è£œåŠ©ï¼š<b id="sumGovSubsidy_foot">0</b></span>
      <span class="warn">è‡ªä»˜ï¼š<b id="sumSelfpay_foot">0</b></span>
      <span>ç¸½é¡ï¼š<b id="sumGrand_foot">0</b></span>
    </div>
  </footer>

  <!-- é˜²æ‹·è…³æœ¬ -->
  <script>
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && ['u','s','p'].includes(e.key.toLowerCase())) e.preventDefault();
      if (e.key === 'F12') e.preventDefault();
    });
    document.addEventListener('selectstart', e => e.preventDefault());
    document.addEventListener('copy', e => e.preventDefault());
  </script>

  <!-- ä½”ä½å€ (åŠŸèƒ½å®Œæ•´ä¿ç•™) -->
  <div id="addonPlaceholders" aria-hidden="true"><span id="addonHint"></span><button id="btnSaveAddons"></button><div id="addonRows"></div><div id="caregiverSalary"></div></div>

  <!-- æœƒå“¡å½ˆçª— -->
  <div id="profile-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <h3>æ­¡è¿åŠ å…¥ï¼è«‹å®Œå–„è³‡æ–™</h3>
      <div style="text-align:left; margin-bottom:12px;">
        <label style="font-weight:700; font-size:15px;">å§“å / ç¨±å‘¼</label>
        <input id="pf-name">
      </div>
      <div style="text-align:left; margin-bottom:12px;">
        <label style="font-weight:700; font-size:15px;">ä½¿ç”¨è€…å¹´é½¡</label>
        <input id="pf-age" type="number">
      </div>
      <div class="modal-actions">
        <button id="btn-save-profile" class="btn pill btn-green" style="width:100%">å„²å­˜ä¸¦é–‹å§‹ä½¿ç”¨</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, setDoc } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase é…ç½® (ä¿æŒä¸è®Š)
    const config={ apiKey: "AIzaSyCZMhdUI0HeIoj5masuRh00pzP3SMbF6Yc", authDomain: "hori-test-1b93c.firebaseapp.com", projectId: "hori-test-1b93c", storageBucket: "hori-test-1b93c.firebasestorage.app", messagingSenderId: "549583061796", appId: "1:549583061796:web:ad58b8bf80c2b6b71c29b1" };
    const app=initializeApp(config), auth=getAuth(app), db=getFirestore(app), provider=new GoogleAuthProvider();

    const dom={ 
        login:document.getElementById('btnLogin'), 
        logout:document.getElementById('btnLogout'), 
        member:document.getElementById('member-area'), 
        user:document.getElementById('userDisplay'), 
        admin:document.getElementById('btnAdminLink'), 
        edit:document.getElementById('btnEditProfile'), 
        modal:document.getElementById('profile-modal'), 
        save:document.getElementById('btn-save-profile'), 
        cloud:document.getElementById('btnSaveCloud'), 
        name:document.getElementById('pf-name'), 
        age:document.getElementById('pf-age'), 
        title:document.querySelector('#profile-modal h3'),
        darkToggle: document.getElementById('darkToggle')
    };

    // --- æ·±è‰²æ¨¡å¼åˆ‡æ›é‚è¼¯ ---
    if (dom.darkToggle) {
        const icon = dom.darkToggle.querySelector('.icon');
        const txt = dom.darkToggle.querySelector('.txt');
        const updateBtnUI = (theme) => {
            icon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            txt.textContent = theme === 'dark' ? 'æ·ºè‰²' : 'æ·±è‰²';
        };
        updateBtnUI(document.documentElement.getAttribute('data-theme'));
        dom.darkToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateBtnUI(newTheme);
        });
    }

    // --- ç™»å…¥é‚è¼¯ ---
    if(dom.login) dom.login.addEventListener('click',()=>signInWithPopup(auth,provider).catch(e=>{
        if(e.code==='auth/popup-blocked')alert("è«‹ä½¿ç”¨ Chrome/Safari ç€è¦½å™¨é–‹å•Ÿ (é LINE/FB å…§å»º)");
        else alert(e.message)
    }));

    if(dom.logout) dom.logout.addEventListener('click',()=>signOut(auth).then(()=>location.reload()));
    
    onAuthStateChanged(auth, async u=>{
      if(u){
        dom.login.style.display='none'; dom.member.style.display='flex'; dom.user.textContent=u.displayName||u.email;
        try{ 
            const s=await getDoc(doc(db,"users",u.uid));
            if(s.exists()){ if(s.data().name) dom.user.textContent=s.data().name; }
            else{ dom.title.textContent="æ­¡è¿åŠ å…¥ï¼è«‹å®Œå–„è³‡æ–™"; dom.name.value=u.displayName||""; dom.modal.style.display='flex'; }
        }catch(e){}
        try{ const a=await getDoc(doc(db,"admins",u.email)); if(a.exists()) dom.admin.style.display='inline-block'; }catch(e){}
      }else{ dom.login.style.display='block'; dom.member.style.display='none'; }
    });

    if(dom.edit) dom.edit.addEventListener('click',async()=>{ const s=await getDoc(doc(db,"users",auth.currentUser.uid)); if(s.exists()){ const d=s.data(); dom.title.textContent="ä¿®æ”¹å€‹äººè³‡æ–™"; dom.name.value=d.name; dom.age.value=d.age; dom.modal.style.display='flex'; } });
    
    if(dom.save) dom.save.addEventListener('click',async()=>{
        const n=dom.name.value, a=dom.age.value; if(!n||!a) return alert("è«‹å¡«å¯«å®Œæ•´");
        const ref=doc(db,"users",auth.currentUser.uid); const s=await getDoc(ref);
        let d={name:n,age:a,email:auth.currentUser.email,lastUpdated:serverTimestamp()};
        if(!s.exists()||!s.data().createdAt) d.createdAt=serverTimestamp();
        await setDoc(ref,d,{merge:true}); alert("å·²å„²å­˜"); dom.modal.style.display='none'; dom.user.textContent=n;
    });

    if(dom.cloud) dom.cloud.addEventListener('click', async()=>{
       if(!auth.currentUser) return alert("è«‹å…ˆç™»å…¥");
       const cms=document.querySelector('input[name="cms"]:checked'), total=document.getElementById('sumGrand');
       try{
           await addDoc(collection(db,"care_records"),{
             uid:auth.currentUser.uid, memberName:dom.user.textContent, email:auth.currentUser.email,
             cmsLevel:cms?cms.value:"0", grandTotal:total?total.textContent:"0", createdAt:serverTimestamp(), note:"é¡åº¦è¨ˆç®—å‚™ä»½"
           });
           alert("å‚™ä»½æˆåŠŸ");
       }catch(e){ alert("å¤±æ•—:"+e.message); }
    });

    if(dom.modal) dom.modal.addEventListener('click',e=>{if(e.target===dom.modal&&auth.currentUser&&dom.user.textContent!="")dom.modal.style.display='none'});
  </script>
</body>
</html>
