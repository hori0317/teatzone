<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>薪資計算機(舊版)</title>
  <meta name="description" content="上傳 PDF，自動統計 BA/AA/GA/SC 支數。AA 依金額÷單價換算（量化為 0.5 倍數）；若為掃描影像自動啟用 OCR（chi_tra+eng）。">

  <style>
    :root{--bg:#f6f8fb;--panel:#fff;--text:#0b1220;--muted:#5b6b81;--accent:#2667ff;--br:16px}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1120px;margin:0 auto;padding:20px 16px 40px}
    .card{background:var(--panel);border:1px solid #e1e6ef;border-radius:var(--br);box-shadow:0 4px 14px rgba(20,40,80,.06);padding:16px;margin:12px 0}
    h1{font-size:1.5rem;margin:.4rem 0}
    .muted{color:var(--muted)}
    .row{display:grid;gap:12px}
    @media(min-width:920px){.row{grid-template-columns:1.15fr .85fr}}
    .drop{border:2px dashed #c7d3ee;border-radius:12px;padding:18px;text-align:center;cursor:pointer;background:#f9fbff}
    .drop:hover{background:#eef4ff}
    input[type=file]{display:none}
    .btn{appearance:none;border:1px solid #c7d3ee;background:#f3f6ff;color:#102a56;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
    thead th{background:#eef3ff;color:#102a56;text-align:left;padding:10px;border-bottom:1px solid #d8e2ff}
    tbody td{padding:10px;border-bottom:1px solid #edf1f7}
    tbody tr:hover{background:#f5f8ff}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef4ff;border:1px solid #dbe6ff;font-size:.85rem;color:#102a56}
    .right{text-align:right}
    .small{font-size:.86rem}
    .grid2{display:grid;gap:12px}
    @media(min-width:720px){.grid2{grid-template-columns:1fr 1fr}}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    #debug{margin-top:12px;padding:10px;border:1px dashed #c7d3ee;background:#f9fbff;border-radius:8px;font-size:12px;white-space:pre-wrap;color:#102a56}
    .progress{height:10px;background:#eef3ff;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0%;background:#2667ff;transition:width .2s}
    .hint{display:inline-block;margin-left:8px;color:#845400}
  </style>

  <!-- 多版本 pdf.js 逐版回退（4.x → 3.x → 2.x；worker 失敗時同執行緒） -->
  <script>
    let __pdfReady = null, __pdfVersionUsed = null;
    async function loadScript(src){
      await new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=()=>rej(new Error('load fail '+src));document.head.appendChild(s);});
    }
    async function tryLoadPdfjs(ver){
      if (window.pdfjsLib) delete window.pdfjsLib;
      await loadScript(https://cdn.jsdelivr.net/npm/pdfjs-dist@${ver}/build/pdf.min.js);
      __pdfVersionUsed = ver;
      try{
        pdfjsLib.GlobalWorkerOptions.workerSrc = https://cdn.jsdelivr.net/npm/pdfjs-dist@${ver}/build/pdf.worker.min.js;
        await pdfjsLib.getDocument({ data: new Uint8Array([0x25,0x50,0x44,0x46,0x2D]) }).promise.catch(()=>null);
      }catch(_){
        pdfjsLib.GlobalWorkerOptions.workerSrc = "";
        pdfjsLib.GlobalWorkerOptions.workerPort = null;
      }
    }
    async function ensurePdfjs(){
      if (__pdfReady){ await __pdfReady; return; }
      __pdfReady = (async ()=>{
        const cand = ["4.2.67","3.11.174","2.16.105"];
        let ok=false,lastErr=null;
        for (const v of cand){
          try{ await tryLoadPdfjs(v); ok=true; break; }catch(e){ lastErr=e; }
        }
        if(!ok) throw lastErr || new Error("pdf.js load failed");
      })();
      await __pdfReady;
    }
  </script>

  <!-- Tesseract OCR（chi_tra+eng） -->
  <script>
    let __ocrReady = null;
    async function ensureTesseract(){
      if (__ocrReady){ await __ocrReady; return; }
      __ocrReady = (async ()=>{
        if(!window.Tesseract){
          await new Promise((res,rej)=>{const s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js';s.onload=res;s.onerror=rej;document.head.appendChild(s);});
        }
        Tesseract.setLogging(false);
      })();
      await __ocrReady;
    }
  </script>
</head>
<body>
  <!-- 共用頂欄注入 -->
  <div id="__header"></div>

  <div class="wrap">
    <h1>PDF 支數自動統計（AA 金額換算）</h1>
    <p class="muted">上傳報表後自動統計 <span class="pill">BA</span> / <span class="pill">AA</span> / <span class="pill">GA</span> / <span class="pill">SC</span>。
      <span class="hint">AA 以「金額 ÷ 單價」換算支數（四捨五入到最接近 0.5）；BA/GA/SC 讀「補助/自費」後的整數。</span></p>

    <div class="card row">
      <div>
        <label class="drop" id="drop">
          <input type="file" id="file" accept="application/pdf" />
          <strong>點我選擇 PDF 或拖曳到這裡</strong>
          <div class="small muted">建議 1～10 頁；掃描影像會自動走 OCR。</div>
        </label>

        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="demo">載入示範資料</button>
          <button class="btn" id="csv" disabled>匯出 CSV</button>
          <button class="btn" id="json" disabled>匯出 JSON</button>
        </div>

        <div class="card small" style="margin-top:12px">
          <details open>
            <summary>AA 單價設定（元/支）</summary>
            <div class="grid2">
              <label>AA05<br><input class="mono" id="p-AA05" type="number" value="200" style="width:100%;padding:8px;border-radius:8px;border:1px solid #d7deea;"></label>
              <label>AA06<br><input class="mono" id="p-AA06" type="number" value="200" style="width:100%;padding:8px;border-radius:8px;border:1px solid #d7deea;"></label>
              <label>AA09<br><input class="mono" id="p-AA09" type="number" value="770" style="width:100%;padding:8px;border-radius:8px;border:1px solid #d7deea;"></label>
              <label>AA11<br><input class="mono" id="p-AA11" type="number" value="50"  style="width:100%;padding:8px;border-radius:8px;border:1px solid #d7deea;"></label>
            </div>
          </details>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="small muted">處理進度</div>
          <div class="progress"><div id="bar" class="bar"></div></div>
          <div id="status" class="small muted" style="margin-top:6px">待上傳</div>
        </div>

        <div id="debug" class="small">偵錯訊息：</div>
      </div>

      <div>
        <div class="card">
          <div class="small muted">分析結果</div>
          <h3>BA 統計</h3>
          <table id="t-BA">
            <thead><tr><th>碼別</th><th class="right">出現筆數</th><th class="right">Σ 支數</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <h3>AA 統計</h3>
          <table id="t-AA">
            <thead><tr><th>碼別</th><th class="right">出現筆數</th><th class="right">Σ 支數</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <h3>GA 統計</h3>
          <table id="t-GA">
            <thead><tr><th>碼別</th><th class="right">出現筆數</th><th class="right">Σ 支數</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <h3>SC 統計</h3>
          <table id="t-SC">
            <thead><tr><th>碼別</th><th class="right">出現筆數</th><th class="right">Σ 支數</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card small">
      <details>
        <summary>解析規則摘要</summary>
        <ul>
          <li>代碼：<code>(BA|AA|GA|SC)\d{2}(?:-\d+)?</code></li>
          <li>BA/GA/SC：支數＝行內「補助 / 自費」後的整數（1–20）。</li>
          <li>AA：支數＝（AA 碼之後最近的金額 ÷ 單價），並**量化為 0.5 的倍數**。</li>
          <li>若 PDF 無文字層，改以 OCR 逐頁辨識後再統計。</li>
        </ul>
      </details>
    </div>
  </div>

  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const debug = $('#debug'), bar = $('#bar'), statusEl = $('#status');
    function log(s){ debug.textContent += (typeof s==='string'?s:JSON.stringify(s,null,2)) + '\n'; console.log('[pdf-stat]', s); }
    function whyStr(e){ return (e && (e.message || e.reason || e.type || e.name)) || String(e); }
    function setBar(p){ bar.style.width = Math.max(0, Math.min(100, p)) + '%'; }

    const fileInput = $('#file');
    const drop = $('#drop');
    const btnDemo = $('#demo');
    const btnCSV = $('#csv');
    const btnJSON = $('#json');

    const tBodies = {
      BA: $('#t-BA tbody'),
      AA: $('#t-AA tbody'),
      GA: $('#t-GA tbody'),
      SC: $('#t-SC tbody'),
    };

    function getAAUnit(){
      return {
        AA05: Number($('#p-AA05').value || 200),
        AA06: Number($('#p-AA06').value || 200),
        AA09: Number($('#p-AA09').value || 770),
        AA11: Number($('#p-AA11').value || 50),
      };
    }

    // 用 pdf.js 擷取文字；data/url 兩種方式都試
    async function extractPdfText(file){
      await ensurePdfjs();
      const ab = await file.arrayBuffer();
      const blob = new Blob([ab], {type:'application/pdf'});
      const url = URL.createObjectURL(blob);

      const ways = [
        {kind:'data', opts:{data: ab}},
        {kind:'url',  opts:{url}}
      ];

      let lastErr=null;
      for (const way of ways){
        try{
          const pdf = await pdfjsLib.getDocument(way.opts).promise;
          let texts = [], total = 0;
          for(let i=1;i<=pdf.numPages;i++){
            const page = await pdf.getPage(i);
            const content = await page.getTextContent({ normalizeWhitespace:true, disableCombineTextItems:false });
            const s = content.items.map(it=>it.str||'').join(' ');
            total += s.length; texts.push(s);
            setBar(100 * i / pdf.numPages);
            statusEl.textContent = PDF 解析中 (${i}/${pdf.numPages}) · pdf.js ${__pdfVersionUsed} · ${way.kind};
          }
          URL.revokeObjectURL(url);
          log(PDF.js 解析（${way.kind}）：頁數 ${pdf.numPages}，總字元 ${total} · 版本 ${__pdfVersionUsed});
          if (pdf.numPages>0) log(預覽：${texts[0].slice(0,200).replace(/\s+/g,' ')});
          return { text: texts.join('\n'), charCount: total, pages: pdf.numPages, pdf };
        }catch(e){
          lastErr=e; log(PDF.js 方式「${way.kind}」失敗：+whyStr(e));
        }
      }
      throw lastErr || new Error('pdf.js all ways failed');
    }

    // OCR：pdf 每頁轉 Canvas → Tesseract
    async function ocrPdfToText(pdf){
      await ensureTesseract();
      const worker = await Tesseract.createWorker('chi_tra+eng');
      try{
        let all = [];
        const total = pdf.numPages;
        for(let i=1;i<=total;i++){
          const page = await pdf.getPage(i);
          const viewport = page.getViewport({ scale: 2.0 });
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d', { willReadFrequently:true });
          canvas.width = viewport.width; canvas.height = viewport.height;
          await page.render({ canvasContext: ctx, viewport }).promise;

          statusEl.textContent = OCR 執行中（第 ${i}/${total} 頁）…;
          setBar(100 * (i-1) / total);
          const res = await worker.recognize(canvas, { rectangle: null });
          all.push(res.data.text || '');
          setBar(100 * i / total);
        }
        const text = all.join('\n');
        log(OCR 完成：總字元 ${text.length});
        log(預覽：${text.slice(0,200).replace(/\s+/g,' ')});
        return text;
      } catch(e){
        log('OCR 錯誤：' + whyStr(e)); throw e;
      } finally {
        await worker.terminate();
      }
    }

    // —— 統計：BA/GA/SC 讀次數；AA 以金額÷單價（且量化為 0.5 倍數）
    function analyze(text){
      const units = getAAUnit();
      const fam = {BA:{}, AA:{}, GA:{}, SC:{}}.
      const lines = text.split(/\r?\n/);
      const codeRe = /\b(BA|AA|GA|SC)\d{2}(?:-\d+)?\b/g;

      const toHalf = v => Math.round(v * 2) / 2;

      for (const raw of lines){
        const line = raw.trim();
        if (!line) continue;

        const codes = [...line.matchAll(codeRe)];
        if (!codes.length) continue;

        for (const m of codes){
          const fullCode = m[0];
          const head = fullCode.slice(0,2);
          const store = fam[head];

          let zhi = 0;

          if (head === 'AA'){
            // 只看「AA 碼之後」的短視窗，拿第一個金額/數字
            const after = line.slice(m.index + fullCode.length, m.index + fullCode.length + 32);
            let amt = null;

            let m1 = after.match(/\$\s*([0-9][0-9,]*)/);
            if (m1){
              amt = parseInt(m1[1].replace(/,/g,''), 10);
            } else {
              let m2 = after.match(/\b([0-9]{2,6})\b/);
              if (m2) amt = parseInt(m2[1], 10);
            }

            const unit = units[fullCode] ?? units[fullCode.slice(0,4)];
            if (unit && amt){
              zhi = toHalf(amt / unit); // 量化為 0.5 的倍數
            }

          } else {
            // BA/GA/SC：從 AA 會抓金額不同，這裡抓「補助/自費」後的整數
            const start = Math.max(0, m.index - 40);
            const end   = Math.min(line.length, m.index + fullCode.length + 40);
            const ctx   = line.slice(start, end);

            const cMatch = ctx.match(/(?:補\s*助|自\s*費)[^0-9]{0,6}([0-9]{1,2})\b/);
            if (cMatch){
              const v = parseInt(cMatch[1],10);
              if (v >= 1 && v <= 20) zhi = v;
            }
          }

          const rec = store[fullCode] || {occ:0,sum:0};
          rec.occ += 1;
          rec.sum += zhi;
          store[fullCode] = rec;
        }
      }

      const rows = obj => Object.entries(obj)
        .map(([code,{occ,sum}]) => ({code, occ, sum}))
        .sort((a,b)=>a.code.localeCompare(b.code));

      return { BA: rows(fam.BA), AA: rows(fam.AA), GA: rows(fam.GA), SC: rows(fam.SC) };
    }

    // 渲染（三欄）
    function renderRows(tbody, rows){
      tbody.innerHTML = '';
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = <td><span class="pill">${r.code}</span></td>
                        <td class="right">${r.occ}</td>
                        <td class="right">${r.sum.toFixed(3)}</td>;
        tbody.appendChild(tr);
      }
    }
    function renderAll(res){
      renderRows(tBodies.BA, res.BA);
      renderRows(tBodies.AA, res.AA);
      renderRows(tBodies.GA, res.GA);
      renderRows(tBodies.SC, res.SC);
    }

    // 匯出
    function exportCSV(res){
      const blk=(title,rows)=>${title}\n碼別,出現筆數,Σ支數\n+rows.map(r=>${r.code},${r.occ},${r.sum.toFixed(3)}).join('\n')+'\n\n';
      const csv= blk('【BA 統計】',res.BA)+blk('【AA 統計】',res.AA)+blk('【GA 統計】',res.GA)+blk('【SC 統計】',res.SC);
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='pdf-stat.csv'; a.click(); URL.revokeObjectURL(url);
    }
    function exportJSON(res){
      const pick = rows => rows.map(r=>({code:r.code,occ:r.occ,sum:Number(r.sum.toFixed(3))}));
      const payload = { BA: pick(res.BA), AA: pick(res.AA), GA: pick(res.GA), SC: pick(res.SC), meta:{generatedAt:new Date().toISOString()} };
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='pdf-stat.json'; a.click(); URL.revokeObjectURL(url);
    }

    let last=null;

    async function handleFile(file){
      debug.textContent='偵錯訊息：\n'; setBar(0); statusEl.textContent='準備解析…';
      let pdfResult=null, text='';
      try{
        pdfResult = await extractPdfText(file);
      }catch(e){
        log('PDF.js 解析失敗，改用 OCR。原因：'+whyStr(e));
      }

      if (pdfResult && pdfResult.charCount>0){
        setBar(100); statusEl.textContent='PDF 文字擷取完成';
        text = pdfResult.text;
      }else{
        // 建立 pdf 物件後走 OCR
        let pdfObj = pdfResult?.pdf;
        if(!pdfObj){
          try{
            await ensurePdfjs();
            const ab = await file.arrayBuffer();
            try{ pdfObj = await pdfjsLib.getDocument({data:ab}).promise; }
            catch(e1){
              const url = URL.createObjectURL(new Blob([ab],{type:'application/pdf'}));
              pdfObj = await pdfjsLib.getDocument({url}).promise;
              URL.revokeObjectURL(url);
            }
          }catch(e){
            log('pdf 物件建立失敗：'+whyStr(e));
            alert('此 PDF 無法解析（可能損壞/受保護）。可先用 Google 雲端硬碟「以 Google 文件開啟」另存後重試。');
            return;
          }
        }
        statusEl.textContent='未偵測到文字，啟用 OCR…（首次可能較久）';
        setBar(1);
        text = await ocrPdfToText(pdfObj);
        setBar(100); statusEl.textContent='OCR 完成';
      }

      if (!text.trim()){ alert('沒有擷取到內容。'); return; }
      const res = analyze(text);
      renderAll(res);
      last = res;
      btnCSV.disabled = btnJSON.disabled = false;
    }

    // 綁定
    fileInput.addEventListener('change', e=>{ const f=e.target.files && e.target.files[0]; if(f) handleFile(f); });
    ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev, e=>{e.preventDefault(); drop.style.background='#eef4ff';}));
    ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev, e=>{e.preventDefault(); drop.style.background='#f9fbff';}));
    drop.addEventListener('drop', e=>{
      e.preventDefault();
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if(f) handleFile(f);
    });

    btnCSV.addEventListener('click', ()=> last && exportCSV(last));
    btnJSON.addEventListener('click', ()=> last && exportJSON(last));

    // 示範資料（AA 金額換算；BA/GA/SC 以次數）
    btnDemo.addEventListener('click', ()=>{
      const demo = 嚴雅雯 賴美女 2025/09/01 AA05 補助 $100
嚴雅雯 賴美女 2025/09/02 AA05 補助 $200
嚴雅雯 張財進 2025/09/02 AA06 自費 $200
嚴雅雯 賴美女 2025/09/06 AA09 補助 $770
嚴雅雯 江昭輝 2025/09/01 AA11 補助 $50
嚴雅雯 范秉殷 2025-09-05 BA01 補助 1 $260
嚴雅雯 江昭輝 2025-09-01 BA07 補助 1 $325
嚴雅雯 張財進 2025-09-02 BA11 自費 2 $195
嚴雅雯 李OO   2025-09-03 GA05 補助 3
嚴雅雯 王OO   2025-09-04 SC02 自費 1;
      const res = analyze(demo);
      renderAll(res);
      last = res;
      btnCSV.disabled = btnJSON.disabled = false;
      setBar(100); statusEl.textContent = '示範資料已載入';
    });
  })();
  </script>

  <!-- 共用底欄注入 -->
  <div id="__footer"></div>
</body>
</html>
