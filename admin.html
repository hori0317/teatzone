<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå° | é•·ç…§å·¥å…·å¹³å°</title>
    <link rel="stylesheet" href="style.css"> 
    <style>
        /* é‡å°å¾Œå°é é¢çš„é¡è‰²è®Šæ•¸å°æ¥ (èˆ‡ style.css çµ±ä¸€) */
        :root {
            --bg-color: var(--bg, #fffaf0);
            --card-bg: var(--card, #ffffff);
            --text-main: var(--ink, #333333);
            --text-sub: var(--muted, #555555);
            --border-color: var(--line, #e6dca8);
            --header-border: var(--line, #e6dca8);
            --table-th-bg: var(--table-head, #f6f1d9);
            --table-th-text: var(--ink, #5b5534);
            --table-hover: var(--table-stripe, #f9f9f9);
            --input-bg: var(--input-bg, #ffffff);
            --input-border: var(--line, #cccccc);
        }

        body { 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto; 
            background-color: var(--bg-color); 
            color: var(--text-main);
            font-family: "Microsoft JhengHei", -apple-system, sans-serif; 
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.5;
        }

        .admin-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            border-bottom: 2px solid var(--header-border); 
            padding-bottom: 10px; 
        }

        .section-card { 
            background: var(--card-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            transition: background-color 0.3s, border-color 0.3s;
        }

        h2 { margin-top: 0; color: var(--green, #2e7d32); font-size: 1.5rem; border-bottom: 1px dashed var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }

        table { width: 100%; border-collapse: collapse; margin-top: 0; background-color: var(--card-bg); }
        th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 15px; }
        th { background-color: var(--table-th-bg); color: var(--table-th-text); font-weight: bold; white-space: nowrap; }
        tr:hover { background-color: var(--table-hover); }

        .admin-controls { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        input.admin-input { 
            padding: 8px 12px; 
            border: 1px solid var(--input-border); 
            border-radius: 8px; 
            flex: 1; 
            min-width: 250px; 
            font-size: 15px; 
            background-color: var(--input-bg);
            color: var(--text-main);
        }

        .btn-group { margin-bottom: 15px; display: flex; gap: 10px; }
        .badge-self { background: #e6fffa; color: #00a080; padding: 2px 8px; border-radius: 10px; font-size: 12px; border: 1px solid #b2f5ea; margin-left: 5px;}
        [data-theme="dark"] .badge-self { background: #1e3a3a; color: #4fd1c5; border-color: #285e5e; }

        .watch-time-cell { font-family: "Courier New", monospace; color: var(--green, #2e7d32); font-weight: bold; font-size: 14px; }
        .raw-seconds { font-size: 11px; color: var(--text-sub); margin-left: 5px; font-weight: normal; }

        /* æ·±è‰²æ¨¡å¼åˆ‡æ›æŒ‰éˆ•æ¨£å¼ (é…åˆå‰å°) */
        .theme-toggle {
            cursor: pointer;
            padding: 8px 14px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-main);
            font-size: 14px;
            margin-right: 15px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .theme-toggle:hover { background-color: var(--table-th-bg); }

        .hint { color: var(--text-sub); font-size: 13px; margin-bottom: 10px; }
    </style>
    <script>
        // ç«‹å³åŸ·è¡Œï¼šåˆå§‹åŒ–æ·±è‰²æ¨¡å¼ (æ”¾åœ¨ Head é¿å…é é¢è¼‰å…¥æ™‚é–ƒçˆ)
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
</head>
<body>

<div class="admin-header">
    <h1>ğŸ› ï¸ ç®¡ç†å“¡å¾Œå°</h1>
    <div style="display: flex; align-items: center;">
        <!-- æ·±è‰²æ¨¡å¼åˆ‡æ› -->
        <button class="theme-toggle" id="themeToggle">
            <span id="themeIcon">ğŸŒ™</span> <span id="themeText">æ·±è‰²æ¨¡å¼</span>
        </button>
        <span id="currentAdminInfo" style="margin-right: 15px; font-weight: bold; color: var(--text-main);">æª¢æŸ¥æ¬Šé™ä¸­...</span>
        <a href="index.html" class="btn pill btn-gray">å›é¦–é </a>
    </div>
</div>

<div id="loading" style="text-align: center; margin-top: 50px;">
    <p style="font-size: 18px; color: var(--text-sub);">æ­£åœ¨é©—è­‰ç®¡ç†å“¡èº«åˆ†...</p>
</div>

<div id="dashboard" style="display: none;">
    
    <!-- æœƒå“¡åˆ—è¡¨ -->
    <div class="section-card">
        <h2>ğŸ‘¥ æœƒå“¡è³‡æ–™åˆ—è¡¨</h2>
        <div class="btn-group">
            <button id="btnRefreshUsers" class="btn pill btn-green" style="font-size:14px;">ğŸ”„ é‡æ–°æ•´ç†åˆ—è¡¨</button>
            <button id="btnExportExcel" class="btn pill btn-orange" style="font-size:14px;">ğŸ“¥ åŒ¯å‡º Excel (CSV)</button>
        </div>
        <div style="overflow-x: auto;">
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>å¹´é½¡</th>
                        <th>Email</th>
                        <th>è¨»å†Šæ™‚é–“</th>
                        <th>ç¸½è§€çœ‹å­¸ç¿’æ™‚é•·</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- è³‡æ–™å°‡ç”± JS å‹•æ…‹å¡«å…¥ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- ç®¡ç†å“¡æ¬Šé™ç®¡ç† -->
    <div class="section-card" id="superAdminSection">
        <h2>ğŸ”‘ ç®¡ç†å“¡æ¬Šé™è¨­å®š</h2>
        <p class="hint">è¼¸å…¥å°æ–¹çš„ Google Email ä¾†è³¦äºˆç®¡ç†æ¬Šé™ã€‚å—é‚€è€…ç™»å…¥å¾Œå³å¯é€²å…¥æ­¤é é¢ã€‚</p>
        <div class="admin-controls">
            <input type="email" id="newAdminEmail" class="admin-input" placeholder="ä¾‹å¦‚ï¼šcolleague@gmail.com">
            <button id="btnAddAdmin" class="btn pill btn-orange">æ–°å¢ç®¡ç†å“¡</button>
        </div>
        <h3 style="font-size: 16px; margin-top: 25px; color: var(--text-main);">ç›®å‰ç®¡ç†å“¡åå–®ï¼š</h3>
        <ul id="adminList" style="list-style: none; padding: 0;">
            <!-- åå–®ç”± JS å¡«å…¥ -->
        </ul>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase é…ç½® (ä¿æŒä¸è®Š)
    const firebaseConfig = {
        apiKey: "AIzaSyCZMhdUI0HeIoj5masuRh00pzP3SMbF6Yc",
        authDomain: "hori-test-1b93c.firebaseapp.com",
        projectId: "hori-test-1b93c",
        storageBucket: "hori-test-1b93c.firebasestorage.app",
        messagingSenderId: "549583061796",
        appId: "1:549583061796:web:ad58b8bf80c2b6b71c29b1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let allUsersData = [], currentUserEmail = "";

    // --- æ·±è‰²æ¨¡å¼é‚è¼¯ ---
    const themeBtn = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const themeText = document.getElementById('themeText');

    function updateThemeUI(theme) {
        if (theme === 'dark') {
            themeIcon.textContent = 'â˜€ï¸';
            themeText.textContent = 'æ·ºè‰²æ¨¡å¼';
        } else {
            themeIcon.textContent = 'ğŸŒ™';
            themeText.textContent = 'æ·±è‰²æ¨¡å¼';
        }
    }

    // åˆå§‹åŒ–æŒ‰éˆ• UI
    updateThemeUI(document.documentElement.getAttribute('data-theme'));

    themeBtn.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeUI(newTheme);
    });

    // --- æ™‚é–“æ ¼å¼åŒ–é‚è¼¯ ---
    function formatTime(totalSeconds) {
        if (!totalSeconds || isNaN(totalSeconds) || totalSeconds <= 0) return "0 ç§’";
        const hrs = Math.floor(totalSeconds / 3600);
        const mins = Math.floor((totalSeconds % 3600) / 60);
        const secs = totalSeconds % 60;
        let result = "";
        if (hrs > 0) result += `${hrs} å°æ™‚ `;
        if (mins > 0 || hrs > 0) result += `${mins} åˆ† `;
        result += `${secs} ç§’`;
        return result;
    }

    // --- èº«åˆ†é©—è­‰é‚è¼¯ ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserEmail = user.email;
            try {
                // æª¢æŸ¥æ˜¯å¦å…·æœ‰ç®¡ç†å“¡æ¬Šé™
                const adminSnap = await getDoc(doc(db, "admins", user.email));
                if (adminSnap.exists()) {
                    let displayName = user.displayName || user.email;
                    // å˜—è©¦å¾ users é›†åˆæŠ“å–çœŸå¯¦å§“å
                    try {
                        const u = await getDoc(doc(db, "users", user.uid));
                        if (u.exists() && u.data().name) displayName = u.data().name;
                    } catch(err){}
                    
                    document.getElementById('currentAdminInfo').textContent = `å—¨ï¼Œ${displayName}`;
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    
                    // è¼‰å…¥è³‡æ–™
                    loadUsers(); 
                    loadAdmins();
                } else {
                    document.body.innerHTML = "<h2 style='text-align:center; margin-top:100px;'>â›” æ¬Šé™ä¸è¶³<br><p style='font-size:16px;'>ä½ ä¸åœ¨ç®¡ç†å“¡åå–®ä¸­ã€‚</p><br><a href='index.html'>å›é¦–é </a></h2>";
                }
            } catch (e) { alert("é©—è­‰éç¨‹å‡ºéŒ¯"); }
        } else {
            document.body.innerHTML = "<h2 style='text-align:center; margin-top:100px;'>è«‹å…ˆç™»å…¥<br><br><a href='index.html'>å›é¦–é </a></h2>";
        }
    });

    // --- è¼‰å…¥æœƒå“¡è³‡æ–™ (å«æ’åºèˆ‡èˆŠæœƒå“¡ç›¸å®¹é‚è¼¯) ---
    async function loadUsers() {
        const tbody = document.querySelector('#usersTable tbody');
        const btn = document.getElementById('btnRefreshUsers');
        btn.disabled = true;
        btn.textContent = "è®€å–ä¸­...";
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px;">æ­£åœ¨è®€å–è³‡æ–™...</td></tr>';
        
        try {
            // ç›´æ¥æŠ“å–æ‰€æœ‰æœƒå“¡ï¼Œä¸ä½¿ç”¨ query orderBy é¿å…æ’é™¤ç¼ºå°‘æ¬„ä½çš„èˆŠè³‡æ–™
            const querySnapshot = await getDocs(collection(db, "users"));
            let rawDataList = [];
            querySnapshot.forEach((docSnap) => { rawDataList.push(docSnap.data()); });

            // åœ¨å‰ç«¯é€²è¡Œæ’åºï¼šç”±æ–°åˆ°èˆŠ (ç¼ºå°‘ createdAt å‰‡æ’åœ¨æœ€å¾Œ)
            rawDataList.sort((a, b) => {
                const timeA = a.createdAt ? (a.createdAt.toMillis ? a.createdAt.toMillis() : new Date(a.createdAt).getTime()) : 0;
                const timeB = b.createdAt ? (b.createdAt.toMillis ? b.createdAt.toMillis() : new Date(b.createdAt).getTime()) : 0;
                return timeB - timeA;
            });

            tbody.innerHTML = '';
            allUsersData = []; 

            if (rawDataList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ç›®å‰ç„¡æœƒå“¡è³‡æ–™</td></tr>';
                return;
            }

            rawDataList.forEach((data) => {
                // è™•ç†æ—¥æœŸå­—ä¸²
                let dateStr = 'æ—©æœŸè¨»å†Š';
                if (data.createdAt) {
                    dateStr = typeof data.createdAt.toDate === 'function' 
                        ? data.createdAt.toDate().toLocaleDateString('zh-TW') 
                        : new Date(data.createdAt).toLocaleDateString('zh-TW');
                }

                const name = data.name || '(æœªå¡«å¯«)';
                const email = data.email || 'ç„¡ Email';
                const age = data.age || '-';
                
                // å­¸ç¿’æ™‚é•·é‚è¼¯ (å°æ¥ video.html ç´¯åŠ çš„ totalWatchTime)
                const totalSec = data.totalWatchTime || 0;
                const formattedTime = formatTime(totalSec);

                // å­˜å…¥å…¨åŸŸè®Šæ•¸ä¾› CSV å°å‡º
                allUsersData.push({ name, age, email, date: dateStr, watchTime: formattedTime, rawSeconds: totalSec });

                tbody.innerHTML += `<tr>
                    <td>${name}</td>
                    <td>${age}</td>
                    <td>${email}</td>
                    <td>${dateStr}</td>
                    <td class="watch-time-cell">
                        ${formattedTime}
                        <span class="raw-seconds">(${totalSec}s)</span>
                    </td>
                </tr>`;
            });
        } catch (e) { 
            console.error(e);
            tbody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">è®€å–å¤±æ•—</td></tr>`; 
        } finally { 
            btn.disabled = false; 
            btn.textContent = "ğŸ”„ é‡æ–°æ•´ç†åˆ—è¡¨"; 
        }
    }

    // --- è¼‰å…¥ç®¡ç†å“¡åå–® ---
    async function loadAdmins() {
        const list = document.getElementById('adminList');
        list.innerHTML = '<li>è¼‰å…¥ä¸­...</li>';
        try {
            const querySnapshot = await getDocs(collection(db, "admins"));
            list.innerHTML = '';
            querySnapshot.forEach((docSnap) => {
                const email = docSnap.id;
                const isSelf = (email === currentUserEmail);
                
                const li = document.createElement('li');
                li.style.cssText = "padding:10px 0; border-bottom:1px dashed var(--border-color); display:flex; justify-content:space-between; align-items:center;";
                
                const btnHtml = isSelf 
                    ? `<span class="badge-self">è‡ªå·±</span>` 
                    : `<button class="btn pill btn-gray" style="font-size:12px; padding:2px 8px;" onclick="removeAdmin('${email}')">ç§»é™¤</button>`;
                
                li.innerHTML = `<b>${email}</b><div>${btnHtml}</div>`;
                list.appendChild(li);
            });
        } catch (e){ list.innerHTML = '<li>è¼‰å…¥å¤±æ•—</li>'; }
    }

    // --- æ–°å¢ç®¡ç†å“¡é‚è¼¯ ---
    document.getElementById('btnAddAdmin').addEventListener('click', async () => {
        const email = document.getElementById('newAdminEmail').value.trim().toLowerCase();
        if(!email) return alert("è«‹è¼¸å…¥ Email");
        try { 
            await setDoc(doc(db, "admins", email), { role: "admin", addedAt: new Date() }); 
            alert("æˆåŠŸæ–°å¢ç®¡ç†å“¡"); 
            document.getElementById('newAdminEmail').value = ''; 
            loadAdmins(); 
        } catch (e) { alert("å¤±æ•—ï¼šæ¬Šé™ä¸è¶³"); }
    });

    // --- ç§»é™¤ç®¡ç†å“¡ (æ›è¼‰è‡³ window ä¾›å…§åµŒ HTML èª¿ç”¨) ---
    window.removeAdmin = async (email) => {
        if (email === currentUserEmail) return alert("ä¸èƒ½ç§»é™¤è‡ªå·±");
        if(!confirm(`ç¢ºå®šç§»é™¤ ${email} çš„ç®¡ç†æ¬Šé™ï¼Ÿ`)) return;
        try { 
            await deleteDoc(doc(db, "admins", email)); 
            alert("å·²ç§»é™¤æ¬Šé™"); 
            loadAdmins(); 
        } catch(e) { alert("å¤±æ•—ï¼šæ¬Šé™ä¸è¶³"); }
    };

    // --- CSV åŒ¯å‡ºé‚è¼¯ ---
    document.getElementById('btnExportExcel').addEventListener('click', () => {
        if (allUsersData.length === 0) return alert("ç„¡è³‡æ–™å¯ä¾›åŒ¯å‡º");
        
        let csvContent = "\uFEFFå§“å,å¹´é½¡,Email,è¨»å†Šæ™‚é–“,ç¸½è§€çœ‹æ™‚é•·,åŸå§‹ç§’æ•¸\n";
        allUsersData.forEach(u => { 
            csvContent += `"${u.name}","${u.age}","${u.email}","${u.date}","${u.watchTime}","${u.rawSeconds}"\n`; 
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        const fileName = `æœƒå“¡å­¸ç¿’é€²åº¦_${new Date().toISOString().split('T')[0]}.csv`;
        
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    document.getElementById('btnRefreshUsers').addEventListener('click', loadUsers);
</script>
</body>
</html>
