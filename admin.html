<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå°</title>
    <link rel="stylesheet" href="style.css"> 
    <style>
        body { padding: 20px; max-width: 1200px; margin: 0 auto; background-color: #fffaf0; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e6dca8; padding-bottom: 10px; }
        .section-card { background: #fff; border: 1px solid #e6dca8; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #2e7d32; font-size: 1.5rem; border-bottom: 1px dashed #eee; padding-bottom: 10px; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #eee; font-size: 15px; }
        th { background-color: #f6f1d9; color: #5b5534; font-weight: bold; white-space: nowrap; }
        tr:hover { background-color: #f9f9f9; }
        .admin-controls { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        input.admin-input { padding: 8px 12px; border: 1px solid #ccc; border-radius: 8px; flex: 1; min-width: 250px; font-size: 15px; }
        .badge-self { background: #e6fffa; color: #00a080; padding: 2px 8px; border-radius: 10px; font-size: 12px; border: 1px solid #b2f5ea; margin-left: 5px;}
    </style>
</head>
<body>
    <div class="admin-header">
        <h1>ğŸ› ï¸ ç®¡ç†å“¡å¾Œå°</h1>
        <div><span id="currentAdminInfo" style="margin-right: 10px;">æª¢æŸ¥ä¸­...</span><a href="index.html" class="btn pill btn-gray">å›é¦–é </a></div>
    </div>

    <div id="loading" style="text-align: center; margin-top: 50px;"><p>é©—è­‰èº«åˆ†ä¸­...</p></div>

    <div id="dashboard" style="display: none;">
        <div class="section-card">
            <h2>ğŸ‘¥ æœƒå“¡åˆ—è¡¨</h2>
            <div style="margin-bottom:15px;"><button id="btnRefreshUsers" class="btn pill btn-green">åˆ·æ–°åˆ—è¡¨</button> <button id="btnExportExcel" class="btn pill btn-orange">åŒ¯å‡º Excel</button></div>
            <div style="overflow-x: auto;">
                <table id="usersTable">
                    <thead><tr><th>å§“å</th><th>å¹´é½¡</th><th>Email</th><th>è¨»å†Šæ™‚é–“</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="section-card">
            <h2>ğŸ”‘ ç®¡ç†å“¡è¨­å®š</h2>
            <div class="admin-controls">
                <input type="email" id="newAdminEmail" class="admin-input" placeholder="ä¾‹å¦‚ï¼šcolleague@gmail.com">
                <button id="btnAddAdmin" class="btn pill btn-orange">æ–°å¢ç®¡ç†å“¡</button>
            </div>
            <ul id="adminList" style="list-style: none; padding: 0; margin-top: 20px;"></ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCZMhdUI0HeIoj5masuRh00pzP3SMbF6Yc",
            authDomain: "hori-test-1b93c.firebaseapp.com",
            projectId: "hori-test-1b93c",
            storageBucket: "hori-test-1b93c.firebasestorage.app",
            messagingSenderId: "549583061796",
            appId: "1:549583061796:web:ad58b8bf80c2b6b71c29b1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allUsersData = [];
        let currentUserEmail = ""; 

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserEmail = user.email;
                try {
                    const adminSnap = await getDoc(doc(db, "admins", user.email));
                    if (adminSnap.exists()) {
                        let displayName = user.displayName || user.email;
                        try {
                            const u = await getDoc(doc(db, "users", user.uid));
                            if (u.exists() && u.data().name) displayName = u.data().name;
                        } catch(err){}
                        
                        document.getElementById('currentAdminInfo').textContent = `å—¨ï¼Œ${displayName}`;
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('dashboard').style.display = 'block';
                        loadUsers();
                        loadAdmins();
                    } else {
                        document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px'>â›” ç„¡ç®¡ç†æ¬Šé™<br><a href='index.html'>å›é¦–é </a></h2>";
                    }
                } catch (e) { alert("é©—è­‰éŒ¯èª¤"); }
            } else {
                document.body.innerHTML = "<h2 style='text-align:center;margin-top:50px'>è«‹å…ˆç™»å…¥<br><a href='index.html'>å›é¦–é </a></h2>";
            }
        });

        async function loadUsers() {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '<tr><td colspan="4">è¼‰å…¥ä¸­...</td></tr>';
            try {
                const snapshot = await getDocs(collection(db, "users"));
                tbody.innerHTML = '';
                allUsersData = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    // â˜… é€™è£¡ä½¿ç”¨ toDate() è½‰æ›æ™‚é–“æˆ³è¨˜
                    let dateStr = 'æœªçŸ¥';
                    if (d.createdAt && typeof d.createdAt.toDate === 'function') {
                        dateStr = d.createdAt.toDate().toLocaleDateString('zh-TW');
                    } else if (d.createdAt) {
                        try{ dateStr = new Date(d.createdAt).toLocaleDateString('zh-TW'); }catch(e){}
                    }

                    const name = d.name || '(æœªå¡«å¯«)';
                    allUsersData.push({ name, age: d.age||'-', email: d.email, date: dateStr });
                    tbody.innerHTML += `<tr><td>${name}</td><td>${d.age||'-'}</td><td>${d.email}</td><td>${dateStr}</td></tr>`;
                });
            } catch (e) { tbody.innerHTML = `<tr><td colspan="4" style="color:red">è®€å–å¤±æ•—</td></tr>`; }
        }

        async function loadAdmins() {
            const list = document.getElementById('adminList');
            list.innerHTML = 'è¼‰å…¥ä¸­...';
            try {
                const snapshot = await getDocs(collection(db, "admins"));
                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const email = doc.id;
                    const isSelf = email === currentUserEmail;
                    const btnHtml = isSelf ? `<span class="badge-self">è‡ªå·±</span>` : `<button class="btn pill btn-gray" style="font-size:12px;padding:2px 8px;" onclick="removeAdmin('${email}')">ç§»é™¤</button>`;
                    const li = document.createElement('li');
                    li.style.cssText = "display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:8px 0;";
                    li.innerHTML = `<b>${email}</b><div>${btnHtml}</div>`;
                    list.appendChild(li);
                });
            } catch(e){}
        }
        
        document.getElementById('btnExportExcel').addEventListener('click', () => {
            if (allUsersData.length===0) return alert("ç„¡è³‡æ–™");
            let csv = "\uFEFFå§“å,å¹´é½¡,Email,è¨»å†Šæ™‚é–“\n";
            allUsersData.forEach(u => { csv += `${u.name},${u.age},${u.email},${u.date}\n`; });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = `æœƒå“¡è³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        });

        document.getElementById('btnAddAdmin').addEventListener('click', async () => {
            const email = document.getElementById('newAdminEmail').value.trim();
            if(!email) return alert("è«‹è¼¸å…¥ Email");
            try {
                await setDoc(doc(db, "admins", email), { role: "admin", addedAt: new Date() });
                alert("æ–°å¢æˆåŠŸ"); loadAdmins();
                document.getElementById('newAdminEmail').value = '';
            } catch (e) { alert("æ¬Šé™ä¸è¶³"); }
        });

        window.removeAdmin = async (email) => {
            if (email === currentUserEmail) return alert("ä¸èƒ½ç§»é™¤è‡ªå·±");
            if (!confirm(`ç§»é™¤ ${email}ï¼Ÿ`)) return;
            try { await deleteDoc(doc(db, "admins", email)); alert("å·²ç§»é™¤"); loadAdmins(); } catch(e) { alert("æ¬Šé™ä¸è¶³"); }
        };
        
        document.getElementById('btnRefreshUsers').addEventListener('click', loadUsers);
    </script>
</body>
</html>
