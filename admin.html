<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•·ç…§ç³»çµ±ç®¡ç†å¾Œå°</title>
    <!-- æ²¿ç”¨ä½ çš„ CSS è®Šæ•¸ -->
    <link rel="stylesheet" href="style.css"> 
    <style>
        body { padding: 20px; max-width: 1200px; margin: 0 auto; background-color: #fffaf0; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e6dca8; padding-bottom: 10px; }
        .section-card { background: #fff; border: 1px solid #e6dca8; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #2e7d32; font-size: 1.5rem; border-bottom: 1px dashed #eee; padding-bottom: 10px; margin-bottom: 15px; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 0; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #eee; font-size: 15px; }
        th { background-color: #f6f1d9; color: #5b5534; font-weight: bold; white-space: nowrap; }
        tr:hover { background-color: #f9f9f9; }

        /* æ¬Šé™ç®¡ç†å€ */
        .admin-controls { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        input.admin-input { padding: 8px 12px; border: 1px solid #ccc; border-radius: 8px; flex: 1; min-width: 250px; font-size: 15px; }
        
        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { margin-bottom: 15px; display: flex; gap: 10px; }
        
        /* ç®¡ç†å“¡åˆ—è¡¨æ¨™ç±¤ */
        .badge-self { background: #e6fffa; color: #00a080; padding: 2px 8px; border-radius: 10px; font-size: 12px; border: 1px solid #b2f5ea; margin-left: 5px;}
    </style>
</head>
<body>

    <div class="admin-header">
        <h1>ğŸ› ï¸ ç®¡ç†å“¡å¾Œå°</h1>
        <div>
            <!-- é€™è£¡é¡¯ç¤ºçš„åå­—æœƒé€é JS æ›´æ–°ç‚ºè‡ªè¨‚å§“å -->
            <span id="currentAdminInfo" style="margin-right: 10px; font-weight: bold; color: #555;">æª¢æŸ¥æ¬Šé™ä¸­...</span>
            <a href="index.html" class="btn pill btn-gray">å›é¦–é </a>
        </div>
    </div>

    <div id="loading" style="text-align: center; margin-top: 50px;">
        <p style="font-size: 18px; color: #666;">æ­£åœ¨é©—è­‰ç®¡ç†å“¡èº«åˆ†...</p>
    </div>

    <!-- ä¸»è¦å…§å®¹å€ (é è¨­éš±è—ï¼Œé©—è­‰é€šéæ‰é¡¯ç¤º) -->
    <div id="dashboard" style="display: none;">
        
        <!-- 1. æœƒå“¡åˆ—è¡¨å€å¡Š -->
        <div class="section-card">
            <h2>ğŸ‘¥ æœƒå“¡è³‡æ–™åˆ—è¡¨</h2>
            
            <div class="btn-group">
                <button id="btnRefreshUsers" class="btn pill btn-green" style="font-size:14px;">é‡æ–°æ•´ç†åˆ—è¡¨</button>
                <button id="btnExportExcel" class="btn pill btn-orange" style="font-size:14px;">åŒ¯å‡º Excel</button>
            </div>

            <div style="overflow-x: auto;">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>å§“å (å¡«å¯«è³‡æ–™)</th>
                            <th>å¹´é½¡</th>
                            <th>Email</th>
                            <th>è¨»å†Šæ™‚é–“</th>
                        </tr>
                    </thead>
                    <tbody><!-- JS è‡ªå‹•å¡«å…¥ --></tbody>
                </table>
            </div>
        </div>

        <!-- 2. ç®¡ç†å“¡æ¬Šé™è¨­å®š -->
        <div class="section-card" id="superAdminSection">
            <h2>ğŸ”‘ ç®¡ç†å“¡æ¬Šé™è¨­å®š</h2>
            <p class="hint">è¼¸å…¥å°æ–¹çš„ Google Email ä¾†è³¦äºˆç®¡ç†æ¬Šé™ã€‚</p>
            
            <div class="admin-controls">
                <input type="email" id="newAdminEmail" class="admin-input" placeholder="ä¾‹å¦‚ï¼šcolleague@gmail.com">
                <button id="btnAddAdmin" class="btn pill btn-orange">æ–°å¢ç®¡ç†å“¡</button>
            </div>
            
            <h3 style="font-size: 16px; margin-top: 25px; color: #5b5534;">ç›®å‰ç®¡ç†å“¡åå–®ï¼š</h3>
            <ul id="adminList" style="list-style: none; padding: 0;"></ul>
        </div>

    </div>

    <!-- Firebase é‚è¼¯ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, getDoc } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ä½ çš„ Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCZMhdUI0HeIoj5masuRh00pzP3SMbF6Yc",
            authDomain: "hori-test-1b93c.firebaseapp.com",
            projectId: "hori-test-1b93c",
            storageBucket: "hori-test-1b93c.firebasestorage.app",
            messagingSenderId: "549583061796",
            appId: "1:549583061796:web:ad58b8bf80c2b6b71c29b1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const dashboard = document.getElementById('dashboard');
        const loading = document.getElementById('loading');
        const currentAdminInfo = document.getElementById('currentAdminInfo');
        
        let allUsersData = [];
        let currentUserEmail = ""; 

        // --- 1. é©—è­‰æ¬Šé™ ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserEmail = user.email;
                
                // A. å…ˆæª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
                const adminRef = doc(db, "admins", user.email);
                try {
                    const adminSnap = await getDoc(adminRef);
                    
                    if (adminSnap.exists()) {
                        // æ˜¯ç®¡ç†å“¡
                        
                        // B. ã€æ–°å¢é‚è¼¯ã€‘å» users é›†åˆæŠ“å–é€™å€‹ç®¡ç†å“¡çš„ã€Œè‡ªè¨‚å§“åã€
                        let displayName = user.displayName || user.email; // é è¨­ç”¨ Google åå­—
                        try {
                            const userProfileRef = doc(db, "users", user.uid);
                            const userProfileSnap = await getDoc(userProfileRef);
                            if (userProfileSnap.exists()) {
                                const profileData = userProfileSnap.data();
                                if (profileData.name) {
                                    displayName = profileData.name; // ç”¨è‡ªè¨‚å§“åè¦†è“‹
                                }
                            }
                        } catch(err) {
                            console.log("æŠ“å–å€‹äººè³‡æ–™å¤±æ•—ï¼Œä½¿ç”¨é è¨­åç¨±");
                        }

                        // æ›´æ–°å³ä¸Šè§’é¡¯ç¤º
                        currentAdminInfo.textContent = `å—¨ï¼Œ${displayName}`;
                        
                        // é¡¯ç¤ºå¾Œå°
                        loading.style.display = 'none';
                        dashboard.style.display = 'block';
                        
                        loadUsers();
                        loadAdmins();
                    } else {
                        document.body.innerHTML = "<h2 style='text-align:center; margin-top:50px;'>â›” æ¬Šé™ä¸è¶³ï¼šä½ ä¸åœ¨ç®¡ç†å“¡åå–®ä¸­<br><br><a href='index.html'>å›é¦–é </a></h2>";
                    }
                } catch (e) {
                    console.error(e);
                    alert("é©—è­‰éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™è¦å‰‡");
                }
            } else {
                document.body.innerHTML = "<h2 style='text-align:center; margin-top:50px;'>è«‹å…ˆç™»å…¥<br><br><a href='index.html'>å›é¦–é </a></h2>";
            }
        });

        // --- 2. è¼‰å…¥æœƒå“¡è³‡æ–™ ---
        async function loadUsers() {
            const tbody = document.querySelector('#usersTable tbody');
            const btn = document.getElementById('btnRefreshUsers');
            const orgText = btn.textContent;
            btn.textContent = "è®€å–ä¸­...";
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#888;">æ­£åœ¨æ›´æ–°è³‡æ–™...</td></tr>';
            
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                tbody.innerHTML = '';
                allUsersData = []; 
                
                if (querySnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ç›®å‰æ²’æœ‰æœƒå“¡è³‡æ–™</td></tr>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'æœªçŸ¥';
                    const realName = data.name || '(æœªå¡«å¯«)';

                    allUsersData.push({
                        name: realName,
                        age: data.age || '-',
                        email: data.email,
                        date: date
                    });

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${realName}</td>
                        <td>${data.age || '-'}</td>
                        <td>${data.email}</td>
                        <td>${date}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("è®€å–æœƒå“¡å¤±æ•—", e);
                tbody.innerHTML = `<tr><td colspan="4" style="color:red; text-align:center;">è®€å–å¤±æ•—ï¼š${e.message}</td></tr>`;
            } finally {
                btn.textContent = orgText;
            }
        }

        // --- 3. åŒ¯å‡º Excel ---
        document.getElementById('btnExportExcel').addEventListener('click', () => {
            if (allUsersData.length === 0) {
                alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º");
                return;
            }
            let csvContent = "\uFEFF"; 
            csvContent += "å§“å,å¹´é½¡,Email,è¨»å†Šæ™‚é–“\n";
            allUsersData.forEach(user => {
                csvContent += `${user.name},${user.age},${user.email},${user.date}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            const today = new Date().toISOString().split('T')[0];
            link.setAttribute("download", `æœƒå“¡è³‡æ–™è¡¨_${today}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- 4. è¼‰å…¥ç®¡ç†å“¡åå–® (é˜²å‘†ï¼šç„¡æ³•ç§»é™¤è‡ªå·±) ---
        async function loadAdmins() {
            const list = document.getElementById('adminList');
            list.innerHTML = '<li>è¼‰å…¥ä¸­...</li>';
            
            try {
                const querySnapshot = await getDocs(collection(db, "admins"));
                list.innerHTML = '';
                
                querySnapshot.forEach((docSnap) => {
                    const adminEmail = docSnap.id; 
                    const li = document.createElement('li');
                    
                    li.style.padding = "10px 0";
                    li.style.borderBottom = "1px dashed #ddd";
                    li.style.display = "flex";
                    li.style.justifyContent = "space-between";
                    li.style.alignItems = "center";
                    
                    // åˆ¤æ–·æ˜¯å¦ç‚ºè‡ªå·±
                    const isSelf = (adminEmail === currentUserEmail);
                    
                    let actionHtml = '';
                    if (isSelf) {
                        actionHtml = `<span class="badge-self">æ‚¨è‡ªå·± (ç„¡æ³•ç§»é™¤)</span>`;
                    } else {
                        actionHtml = `<button class="btn pill btn-gray" style="font-size:12px; padding:4px 10px;" onclick="removeAdmin('${adminEmail}')">ç§»é™¤æ¬Šé™</button>`;
                    }

                    li.innerHTML = `
                        <span style="font-weight:bold; color:#333;">${adminEmail}</span>
                        <div>${actionHtml}</div>
                    `;
                    list.appendChild(li);
                });
            } catch (e) {
                console.error(e);
            }
        }

        // --- 5. æ–°å¢ç®¡ç†å“¡ ---
        document.getElementById('btnAddAdmin').addEventListener('click', async () => {
            const email = document.getElementById('newAdminEmail').value.trim();
            if(!email) return alert("è«‹è¼¸å…¥ Email");
            if(!email.includes('@')) return alert("Email æ ¼å¼ä¸æ­£ç¢º");

            try {
                await setDoc(doc(db, "admins", email), {
                    role: "admin",
                    addedAt: new Date()
                });
                alert(`æˆåŠŸï¼å·²å°‡ ${email} è¨­ç‚ºç®¡ç†å“¡`);
                document.getElementById('newAdminEmail').value = '';
                loadAdmins();
            } catch (e) {
                console.error(e);
                alert("æ–°å¢å¤±æ•—ï¼šåªæœ‰è¶…ç´šç®¡ç†å“¡å¯ä»¥åŸ·è¡Œæ­¤å‹•ä½œã€‚");
            }
        });

        // --- 6. ç§»é™¤ç®¡ç†å“¡ ---
        window.removeAdmin = async function(email) {
            if (email === currentUserEmail) {
                alert("â›” æ“ä½œç¦æ­¢ï¼šæ‚¨ä¸èƒ½ç§»é™¤è‡ªå·±çš„ç®¡ç†å“¡æ¬Šé™ï¼");
                return;
            }
            if(!confirm(`ç¢ºå®šè¦ç§»é™¤ ${email} çš„ç®¡ç†æ¬Šé™å—ï¼Ÿ`)) return;
            
            try {
                await deleteDoc(doc(db, "admins", email));
                alert("å·²ç§»é™¤");
                loadAdmins();
            } catch (e) {
                console.error(e);
                alert("ç§»é™¤å¤±æ•—ï¼šæ¬Šé™ä¸è¶³");
            }
        };
        
        document.getElementById('btnRefreshUsers').addEventListener('click', loadUsers);

    </script>
</body>
</html>
