<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>薪資計算機｜長照工具</title>
  <meta name="description" content="輸入本月 AA / BA / GA / SC 的支數，計總額並依比例拆薪；可從 PDF 自動統計並選擇是否同步，右側即時比對勞健保扣款，得出實領。">
  <link rel="icon" type="image/x-icon" href="YORU.ico" />
  <link rel="stylesheet" href="style.css" />
  <script src="nav.js" defer></script>
  <style>
    /* =======================================
       Payroll 頁面專屬修正樣式
       ======================================= */
    
    /* 彈窗 */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(47,47,32,0.6); backdrop-filter: blur(3px); 
        z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px; 
    }
    .modal-content { 
        background: #fffdf5; border: 1px solid #e6dca8; border-radius: 12px; 
        padding: 24px; width: 100%; max-width: 420px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); text-align: center; 
    }
    .modal-content h3 { color: #2e7d32; margin-top: 0; }
    .modal-content input { 
        width: 100%; padding: 10px; border: 1px solid #e6dca8; background: #fff; 
        border-radius: 8px; font-size: 16px; margin-top: 4px; box-sizing: border-box; 
    }
    .modal-actions { margin-top: 20px; }

    /* PDF 區塊 */
    .ps-muted{color:#5b6b81}.ps-small{font-size:.86rem}.ps-mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .ps-pill{display:inline-block;padding:0 6px;border:1px solid #dbe6ff;background:#eef4ff;border-radius:999px}
    .ps-grid{display:grid;gap:12px}@media(min-width:920px){.ps-grid{grid-template-columns:1.1fr .9fr}}
    .ps-drop{border:2px dashed #c7d3ee;border-radius:12px;padding:18px;text-align:center;cursor:pointer;background:#f9fbff;display:block} .ps-drop:hover{background:#eef4ff}
    .ps-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .ps-btn{border:1px solid #c7d3ee;background:#f3f6ff;color:#102a56;padding:8px 12px;border-radius:10px;cursor:pointer} .ps-btn:disabled{opacity:.5}
    .ps-box{background:#fff;border:1px solid #e1e6ef;border-radius:12px;padding:12px;margin-top:10px}
    .ps-progress{height:10px;background:#eef3ff;border-radius:999px;overflow:hidden}
    .ps-bar{height:100%;width:0;background:#2667ff;transition:width .2s}
    .ps-h3{margin:.2rem 0 8px}
    .ps-table{width:100%;border-collapse:collapse} .ps-table thead th{background:#eef3ff;color:#102a56;text-align:left;padding:8px} .ps-table td{padding:8px;border-bottom:1px solid #edf1f7} .ps-right{text-align:right} .ps-syncbar{border-color:#c7e7c7;background:#f6fff6}

    /* KPI 卡片 */
    .kpi{display:flex; gap:16px; flex-wrap:wrap;}
    .kpi .box{flex:1 1 240px; background:#fff; border:1px solid var(--line); border-radius:12px; padding:16px; display:flex; flex-direction:column; gap:6px; box-shadow:0 1px 2px rgba(0,0,0,.05);}
    .kpi .box .lbl{color:#7a7557; font-weight:700;}
    .kpi .box .num{font-size:24px; font-weight:900; color:#2e7d32;}

    /* ★★★ 表格通用基礎設定 ★★★ */
    .tbl{ width:100%; border-collapse:separate; border-spacing:0; background:#fff; border:1px solid var(--line); border-radius:12px; overflow:hidden; table-layout: fixed; }
    
    .tbl th{ background:#f6f1d9; color:#5b5534; padding:12px; font-weight:800; border-bottom:1px solid var(--line); font-size: 15px;}
    .tbl td{ padding:12px; border-top:1px solid var(--line); font-size: 15px; vertical-align: middle; }
    
    .tbl tbody tr:nth-child(even){ background:#fffef9; }
    .tbl input[type="number"]{ width:80px; height:34px; text-align:right; border:1px solid #ddd; border-radius:4px; margin: 0 auto; display:block;}
    .tbl .right{ text-align:right; }
    .tbl .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }

    /* ★ 投保級距表格專屬 ★ */
    .insurance-table { table-layout: auto !important; width: 100%; }
    .insurance-table input { width: 100% !important; min-width: 60px; }
    .sub-text { font-size: 11px; display: block; color: #777; line-height: 1.2; }
    
    .auto-chip {
        display: flex !important; align-items: center !important; justify-content: flex-start !important;
        padding: 4px 12px !important; white-space: nowrap !important; gap: 6px !important;
    }
    .auto-chip input { margin: 0 !important; width: auto !important; min-width: 0 !important; cursor: pointer; }

    /* 其他排版 */
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:14px;}
    .row-mid{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .pill-note{display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; background:#fff; font-weight:700; color:#333;}
    
    /* ============================================================
       【重點修正 1：保險表格強制置中】
       使用 !important 確保此頁面的樣式擁有最高優先級。
       ============================================================ */
    .tbl.insurance-table th,
    .tbl.insurance-table td {
        text-align: center !important; 
        padding-left: 8px !important;
        padding-right: 8px !important;
        vertical-align: middle !important;
    }
    .tbl.insurance-table th:first-child,
    .tbl.insurance-table td:first-child {
        text-align: left !important; /* 第一欄(級距選單)靠左較符合使用習慣 */
        padding-left: 15px !important;
    }
    .tbl.insurance-table tbody td input {
        display: block;
        margin: 0 auto !important;     /* 輸入框本身在格子內置中 */
        text-align: center !important;  /* 輸入的文字也在輸入框內置中 */
    }

    /* ============================================================
       【重點修正 2：單價靠右對齊 (一般薪資表)】
       將單價(第2欄)與小計(第4欄)的右邊距統一設為 20px。
       ============================================================ */
    /* 1. 代碼 (靠左) */
    .tbl:not(.insurance-table) th:first-child, 
    .tbl:not(.insurance-table) td:first-child { 
        text-align: left !important; 
        padding-left: 20px !important; 
    }
    /* 2 & 4. 單價與小計 (靠右對齊) */
    .tbl:not(.insurance-table) th:nth-child(2),
    .tbl:not(.insurance-table) td:nth-child(2),
    .tbl:not(.insurance-table) th:nth-child(4),
    .tbl:not(.insurance-table) td:nth-child(4) {
        text-align: right !important; 
        padding-right: 20px !important; /* 統一右邊距 */
    }
    /* 3. 支數 (置中) */
    .tbl:not(.insurance-table) th:nth-child(3),
    .tbl:not(.insurance-table) td:nth-child(3) {
        text-align: center !important;
    }

    /* 一般薪資表內的 input 寬度 */
    body[data-page="payroll"] .tbl:not(.insurance-table) input[type="number"] {
        width: 90px !important;
    }

    @media (max-width:860px){
      .grid-2{grid-template-columns:1fr;}

      /* 手機版卡片化 */
      .tbl:not(.insurance-table){display:block; font-size:15px; border:0; background:none; overflow:visible;}
      .tbl:not(.insurance-table) thead{display:none;}
      .tbl:not(.insurance-table) tbody,
      .tbl:not(.insurance-table) tfoot{display:block; width:100%;}
      .tbl:not(.insurance-table) tbody tr{display:block; border:1px solid var(--line); border-radius:12px; padding:10px 12px; margin-bottom:12px; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.05);}
      
      .tbl:not(.insurance-table) td{
        display:flex; gap:12px; justify-content:space-between; align-items:center;
        padding:6px 0 !important; /* 清除內距 */
        border-top:none;
      }
      .tbl:not(.insurance-table) td[data-label]::before{
        content:attr(data-label); font-weight:700; color:#5b5534; flex:1; text-align:left;
      }
      
      /* [手機] 強制單價/小計數字往最右邊靠 */
      .tbl:not(.insurance-table) td[data-label="單價"] .cell-val,
      .tbl:not(.insurance-table) td[data-label="小計"] .cell-val {
        margin-left: auto !important;
      }

      .tbl:not(.insurance-table) td[data-label="本月支數"] input {
        margin-left: auto !important;
      }
    }
  </style>
</head>
<body data-page="payroll">
  <div class="watermark" aria-hidden="true">
    <span class="wm-item" style="top:5%; left:5%;  --dur:9s;">@hori版權所有</span>
    <span class="wm-item" style="top:50%; left:50%; --dur:10s;">@hori版權所有</span>
    <span class="wm-item" style="top:5%; left:65%; --dur:10s;">@hori版權所有</span>
    <span class="wm-item" style="top:25%; left:10%; --dur:13s;">@hori版權所有</span>
    <span class="wm-item" style="top:75%; left:70%; --dur:14s;">@hori版權所有</span>
  </div>
  <header class="topbar">
    <div class="brand">
      <a href="index.html" class="logo-link"><img src="org-logo.png" alt="logo" onerror="this.style.opacity=0.2" /></a>
      <span class="site-title" id="siteTitle" data-sync-title>薪資計算機</span>
    </div>
    <nav class="nav-links" aria-label="主選單">
      <a href="calculator.html">額度計算機</a>
      <a href="payroll.html">薪資計算機</a>
      <a href="video.html">影音專區</a>
      <a href="care-info.html">長照資訊</a>
      <a href="news.html">最新公告</a>
      <a href="contact.html">聯繫方式</a>
      <a href="about.html">關於我們</a>
    </nav>
    <div class="actions" style="align-items: center; gap: 8px;">
      <button class="btn pill btn-gray" id="btnPrint" type="button">列印</button>
      <button class="btn pill btn-green" id="btnResetAll" type="button">全部清空</button>
      <div style="width: 1px; height: 20px; background: #ccc; margin: 0 4px;"></div>
      <button class="btn pill" style="background:#4285F4; color:white;" id="btnLogin" type="button">Google 登入</button>
      <div id="member-area" style="display:none; align-items: center; gap:5px;">
          <span id="userDisplay" style="font-size: 13px; font-weight: bold; color: #333; margin-right: 4px;"></span>
          <a href="admin.html" id="btnAdminLink" class="btn pill" style="background:#673AB7; color:white; font-size:12px; padding:4px 10px; text-decoration:none; display:none;">管理後台</a>
          <button class="btn pill" style="background:#777; color:white; font-size:12px; padding:4px 10px;" id="btnEditProfile" type="button">修改資料</button>
          <button class="btn pill" style="background:#EA4335; color:white;" id="btnLogout" type="button">登出</button>
      </div>
    </div>
  </header>
  
  <div class="divider"></div>
  
  <main class="container">
    <section class="card" style="margin-bottom:16px;">
      <h1 class="card-title" style="font-size:22px;">本月薪資總覽</h1>
      <p class="hint">輸入各碼別本月支數 → 計總額 → 依比例拆薪；右側即時比對勞健保扣款，算出「實領」。</p>
      <div class="kpi" style="margin-top:10px;">
        <div class="box"><div class="lbl">AA 小計</div><div class="num" id="kpiAA">0</div></div>
        <div class="box"><div class="lbl">BA 小計</div><div class="num" id="kpiBA">0</div></div>
        <div class="box"><div class="lbl">GA 小計</div><div class="num" id="kpiGA">0</div></div>
        <div class="box"><div class="lbl">SC 小計</div><div class="num" id="kpiSC">0</div></div>
        <div class="box"><div class="lbl">全月總額</div><div class="num" id="kpiTotal">0</div></div>
        <div class="box"><div class="lbl">拆薪後薪資</div><div class="num" id="kpiSalary">0</div></div>
        <div class="box"><div class="lbl">勞健保合計</div><div class="num" id="kpiIns">0</div></div>
        <div class="box"><div class="lbl">實領</div><div class="num" id="kpiNet">0</div></div>
      </div>
    </section>

    <section class="card">
      <h2 class="card-title">① 拆薪比例</h2>
      <div class="grid-2" style="margin-top:8px;">
        <div class="row-mid">
          <label style="min-width:120px;font-weight:700;">拆薪比例（%）</label>
          <input id="ratioPct" type="number" min="0" max="100" step="0.1" value="60" style="height:34px;width:120px;text-align:right;">
          <span class="hint">例：6/4 → 填 60</span>
        </div>
        <div class="row-mid">
          <label style="min-width:120px;font-weight:700;">月份</label>
          <input id="plMonth" type="month" style="height:34px;width:180px;">
        </div>
      </div>
    </section>

    <section class="card ps-card" id="ps-widget">
      <h2 class="card-title">PDF 支數自動統計（帶入表單）</h2>
      <p class="ps-muted">上傳每月 PDF，統計 <span class="ps-pill">BA</span> / <span class="ps-pill">AA</span> / <span class="ps-pill">GA</span> / <span class="ps-pill">SC</span>。AA 以「金額 ÷ 單價」換算（四捨五入到最接近 0.5），AA 單價固定。</p>

      <label class="ps-drop" id="ps-drop">
        <input type="file" id="ps-file" accept="application/pdf" />
        <strong>點我選擇 PDF 或拖曳到這裡</strong>
        <div class="ps-small ps-muted">無文字層將自動 OCR（繁中＋英文）。</div>
      </label>

      <div class="ps-btns">
        <button class="ps-btn" id="ps-demo" type="button">載入示範資料</button>
        <button class="ps-btn" id="ps-apply" type="button" disabled>帶入上方表單</button>
        <button class="ps-btn" id="ps-csv" type="button" disabled>匯出 CSV</button>
        <button class="ps-btn" id="ps-json" type="button" disabled>匯出 JSON</button>
      </div>

      <label class="ps-small ps-muted" style="display:inline-flex;align-items:center;gap:6px;margin-top:6px;">
        <input id="ps-auto-sync" type="checkbox"> 匯入後自動同步到下方支數
      </label>

      <div id="ps-syncbar" class="ps-syncbar ps-box" style="display:none;align-items:center;justify-content:space-between;gap:8px;">
        <div class="ps-small">已解析出支數，要同步到下方表格（AA/BA/GA/SC）並立即計算薪資嗎？</div>
        <div style="display:flex;gap:8px;">
          <button id="ps-sync-yes" class="ps-btn">同步</button>
          <button id="ps-sync-no" class="ps-btn" style="background:#fff;">先不要</button>
        </div>
      </div>

      <div class="ps-box">
        <div class="ps-small ps-muted">處理進度</div>
        <div class="ps-progress"><div id="ps-bar" class="ps-bar"></div></div>
        <div id="ps-status" class="ps-small ps-muted" style="margin-top:6px">待上傳</div>
      </div>
      <pre id="ps-debug" class="ps-box ps-small" style="white-space:pre-wrap">偵錯訊息：</pre>

      <div style="display:grid;gap:12px;margin-top:10px;">
        <div class="ps-box">
          <h3 class="ps-h3">BA 統計</h3>
          <table id="ps-t-BA" class="ps-table">
            <thead><tr><th>碼別</th><th class="ps-right">出現筆數</th><th class="ps-right">Σ 支數</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="ps-box">
          <h3 class="ps-h3">AA 統計</h3>
          <table id="ps-t-AA" class="ps-table">
            <thead><tr><th>碼別</th><th class="ps-right">出現筆數</th><th class="ps-right">Σ 支數</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="ps-box">
          <h3 class="ps-h3">GA 統計</h3>
          <table id="ps-t-GA" class="ps-table">
            <thead><tr><th>碼別</th><th class="ps-right">出現筆數</th><th class="ps-right">Σ 支數</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="ps-box">
          <h3 class="ps-h3">SC 統計</h3>
          <table id="ps-t-SC" class="ps-table">
            <thead><tr><th>碼別</th><th class="ps-right">出現筆數</th><th class="ps-right">Σ 支數</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 class="card-title">② AA 本月支數</h2>
      <table class="tbl" id="tblAA">
        <colgroup>
          <col class="col-code" style="width: 35%;">
          <col class="col-price" style="width: 20%;">
          <col class="col-month" style="width: 25%;">
          <col class="col-sum" style="width: 20%;">
        </colgroup>
        <thead><tr><th>代碼</th><th>單價</th><th>本月支數</th><th>小計</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th colspan="3" class="right">AA 小計</th><th class="right" id="sumAA">0</th></tr></tfoot>
      </table>
      <p class="hint" style="margin-top:8px;">單價固定：AA05 200、AA06 200、AA07 760、AA08 385、AA09 770、AA11 50。</p>
    </section>

    <section class="card">
      <h2 class="card-title">③ BA 本月支數</h2>
      <table class="tbl" id="tblBA">
        <colgroup>
          <col class="col-code" style="width: 35%;">
          <col class="col-price" style="width: 20%;">
          <col class="col-month" style="width: 25%;">
          <col class="col-sum" style="width: 20%;">
        </colgroup>
        <thead><tr><th>代碼＋名稱</th><th>單價</th><th>本月支數</th><th>小計</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th colspan="3" class="right">BA 小計</th><th class="right" id="sumBA">0</th></tr></tfoot>
      </table>
    </section>

    <section class="card">
      <h2 class="card-title">④ GA 本月支數</h2>
      <table class="tbl" id="tblGA">
        <colgroup>
          <col class="col-code" style="width: 35%;">
          <col class="col-price" style="width: 20%;">
          <col class="col-month" style="width: 25%;">
          <col class="col-sum" style="width: 20%;">
        </colgroup>
        <thead><tr><th>代碼＋名稱</th><th>單價</th><th>本月支數</th><th>小計</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th colspan="3" class="right">GA 小計</th><th class="right" id="sumGA">0</th></tr></tfoot>
      </table>
    </section>

    <section class="card">
      <h2 class="card-title">⑤ SC 本月支數</h2>
      <table class="tbl" id="tblSC">
        <colgroup>
          <col class="col-code" style="width: 35%;">
          <col class="col-price" style="width: 20%;">
          <col class="col-month" style="width: 25%;">
          <col class="col-sum" style="width: 20%;">
        </colgroup>
        <thead><tr><th>代碼＋名稱</th><th>單價</th><th>本月支數</th><th>小計</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th colspan="3" class="right">SC 小計</th><th class="right" id="sumSC">0</th></tr></tfoot>
      </table>
    </section>

    <section class="card">
      <h2 class="card-title">⑥ 薪資結果 & 勞健保扣款</h2>
      <div class="grid-2" style="margin-top:8px;">
        <div class="card" style="padding:14px;">
          <table class="tbl">
            <tbody>
              <tr><td>AA 小計</td><td class="right mono" id="resAA">0</td></tr>
              <tr><td>BA 小計</td><td class="right mono" id="resBA">0</td></tr>
              <tr><td>GA 小計</td><td class="right mono" id="resGA">0</td></tr>
              <tr><td>SC 小計</td><td class="right mono" id="resSC">0</td></tr>
              <tr><td><b>全月總額</b></td><td class="right mono" id="resTotal"><b>0</b></td></tr>
              <tr><td>拆薪比例</td><td class="right mono"><span id="resRatio">60</span>%</td></tr>
              <tr><td><b>拆薪後薪資</b></td><td class="right mono" id="resSalary"><b>0</b></td></tr>
              <tr><td><b>實領（扣勞健保）</b></td><td class="right mono" id="resNet"><b>0</b></td></tr>
            </tbody>
          </table>
        </div>
        <div class="card" style="padding:14px;">
          <div class="row-mid" style="margin-bottom:10px;">
            <span class="pill-note">自動依「拆薪後薪資」抓 ≥ 薪資的最大投保級距</span>
          </div>
          <!-- 投保級距表格 -->
          <table class="tbl insurance-table">
            <colgroup>
                <col style="width:28%;">
                <col style="width:22%;">
                <col style="width:22%;">
                <col style="width:14%;">
                <col style="width:14%;">
            </colgroup>
            <thead>
                <tr>
                    <th>投保級距</th>
                    <th>勞保<br><span class="sub-text">(員工)</span></th>
                    <th>健保<br><span class="sub-text">(員工)</span></th>
                    <th>合計</th>
                    <th>設定</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td data-label="投保級距"><select id="insGrade" style="width:100%;"></select></td>
                    <td data-label="勞保(員工)"><input id="insLabor" type="number" min="0" step="1" value="0"></td>
                    <td data-label="健保(員工)"><input id="insHealth" type="number" min="0" step="1" value="0"></td>
                    <td class="right mono" id="insSum" data-label="合計">0</td>
                    <td data-label="設定">
                        <label class="chip auto-chip"><input id="insAuto" type="checkbox" checked> 自動</label>
                    </td>
                </tr>
            </tbody>
          </table>
          <div class="row-mid" style="margin-top:12px;">
            <div class="pill-note">實領（拆薪後薪資－勞健保合計）：<b class="mono" id="netPay">0</b></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer id="bottomDock" class="footerbar">
    <div class="foot">
      <span class="ok">※ 每年 <b>2 月</b> 和 <b>8 月</b> 調整投保級距，並於次月 <b>1 號</b> 生效。</span>
    </div>
  </footer>

  <div id="profile-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <h3>歡迎加入！請完善資料</h3>
      <p>填寫您的基本資訊，讓我們為您記錄試算結果。</p>
      <div style="text-align:left; margin-bottom:12px;">
        <label style="font-weight:700; color:var(--ink); font-size:15px;">姓名 / 稱呼</label>
        <input type="text" id="pf-name" placeholder="例如：王小明">
      </div>
      <div style="text-align:left; margin-bottom:12px;">
        <label style="font-weight:700; color:var(--ink); font-size:15px;">使用者年齡</label>
        <input type="number" id="pf-age" placeholder="例如：65">
      </div>
      <div class="modal-actions">
        <button id="btn-save-profile" class="btn pill btn-green" style="width:100%; font-size:16px; padding:10px;">
          儲存並開始使用
        </button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));
      const N = v => (isFinite(+v) ? +v : 0);
      const F = v => new Intl.NumberFormat('zh-Hant-TW', { maximumFractionDigits: 0 }).format(v);

      const PRICE = {
        AA: { AA05:200, AA06:200, AA07:760, AA08:385, AA09:770, AA11:50 },
        BA: [
          { code:"BA01", name:"基本身體清潔", price:260 }, { code:"BA02", name:"基本日常照顧", price:195 },
          { code:"BA03", name:"測量生命徵象", price:35 }, { code:"BA04", name:"協助進食或管灌", price:130 },
          { code:"BA05", name:"餐食照顧", price:310 }, { code:"BA07", name:"協助沐浴及洗頭", price:325 },
          { code:"BA08", name:"足部照護", price:500 }, { code:"BA10", name:"翻身拍背", price:155 },
          { code:"BA11", name:"肢體關節活動", price:195 }, { code:"BA12", name:"協助上下樓梯", price:130 },
          { code:"BA13", name:"陪同外出", price:195 }, { code:"BA14", name:"陪同就醫", price:685 },
          { code:"BA15-1", name:"家務協助-1", price:195 }, { code:"BA15-2", name:"家務協助-2", price:195 },
          { code:"BA16", name:"代購", price:130 }, { code:"BA17a", name:"人工氣道管抽吸", price:75 },
          { code:"BA17b", name:"口腔內抽吸", price:65 }, { code:"BA17c", name:"管路清潔", price:50 },
          { code:"BA17d", name:"通便/驗血糖", price:50 }, { code:"BA17e", name:"依指示置入藥盒", price:50 },
          { code:"BA18", name:"安全看視", price:200 }, { code:"BA20", name:"陪伴服務", price:175 },
          { code:"BA22", name:"巡視服務", price:130 }, { code:"BA23", name:"協助洗頭", price:200 },
          { code:"BA24", name:"協助排泄", price:220 }
        ],
        GA: [{ code:"GA09", name:"喘息 2 小時/支", price:770 }],
        SC: [{ code:"SC09", name:"短照 2 小時/支", price:770 }]
      };

      const INS_TABLE = [
        { grade:11100, labor:277, health:443 }, { grade:12540, labor:313, health:443 },
        { grade:13500, labor:338, health:443 }, { grade:15840, labor:396, health:443 },
        { grade:16500, labor:413, health:443 }, { grade:17280, labor:432, health:443 },
        { grade:19047, labor:476, health:443 }, { grade:20008, labor:505, health:443 },
        { grade:21009, labor:525, health:443 }, { grade:22000, labor:550, health:443 },
        { grade:23100, labor:577, health:443 }, { grade:24000, labor:600, health:443 },
        { grade:25250, labor:632, health:443 }, { grade:26400, labor:660, health:443 },
        { grade:27600, labor:690, health:443 }, { grade:28590, labor:715, health:443 },
        { grade:28800, labor:720, health:447 }, { grade:30300, labor:758, health:472 },
        { grade:31800, labor:795, health:493 }, { grade:33300, labor:833, health:516 },
        { grade:34800, labor:870, health:540 }, { grade:36300, labor:908, health:563 },
        { grade:38200, labor:955, health:592 }, { grade:40100, labor:1002, health:622 },
        { grade:41900, labor:1045, health:651 }, { grade:43900, labor:1098, health:681 },
        { grade:45800, labor:1145, health:710 }, { grade:50600, labor:1145, health:785 },
        { grade:53000, labor:1145, health:822 }, { grade:55400, labor:1145, health:859 },
        { grade:57800, labor:1145, health:896 }, { grade:60800, labor:1145, health:943 },
        { grade:63800, labor:1145, health:990 }, { grade:66800, labor:1145, health:1036 },
        { grade:69800, labor:1145, health:1083 }, { grade:72800, labor:1145, health:1129 },
        { grade:76500, labor:1145, health:1187 }, { grade:80200, labor:1145, health:1244 },
        { grade:83900, labor:1145, health:1301 }, { grade:87600, labor:1145, health:1359 },
        { grade:92100, labor:1145, health:1428 }, { grade:96600, labor:1145, health:1498 },
        { grade:101100, labor:1145, health:1568 }, { grade:105600, labor:1145, health:1638 },
        { grade:110100, labor:1145, health:1708 }, { grade:115500, labor:1145, health:1791 },
        { grade:120900, labor:1145, health:1875 }, { grade:126300, labor:1145, health:1959 },
        { grade:131700, labor:1145, health:2043 }, { grade:137100, labor:1145, health:2126 },
        { grade:142500, labor:1145, health:2210 }, { grade:147900, labor:1145, health:2294 },
        { grade:150000, labor:1145, health:2327 }
      ];

      function buildAA(){
        const host = document.querySelector('#tblAA tbody');
        host.innerHTML = '';
        const saved = loadLS('pl-aa', {});
        Object.keys(PRICE.AA).forEach(code=>{
          const price = PRICE.AA[code];
          const tr = document.createElement('tr');
          tr.innerHTML =
            `<td data-label="代碼"><span class="cell-val">${code}</span></td>` +
            `<td data-label="單價"><span class="cell-val">${F(price)}</span></td>` +
            `<td data-label="本月支數"><input type="number" min="0" step="1" value="${N(saved[code]||0)}" data-aa="${code}"></td>` +
            `<td data-label="小計"><span class="cell-val" data-aa-sum="${code}">0</span></td>`;
          host.appendChild(tr);
        });
      }
      function buildGroup(tableId, key, savedKey){
        const host = document.querySelector(`#${tableId} tbody`);
        host.innerHTML = '';
        const saved = loadLS(savedKey, {});
        const k = key.toLowerCase();
        PRICE[key].forEach(item=>{
          const tr = document.createElement('tr');
          tr.innerHTML =
            `<td data-label="代碼＋名稱"><span class="cell-val">${item.code}${item.name ? ' ' + item.name : ''}</span></td>` +
            `<td data-label="單價"><span class="cell-val">${F(item.price)}</span></td>` +
            `<td data-label="本月支數"><input type="number" min="0" step="1" value="${N(saved[item.code]||0)}" data-${k}="${item.code}"></td>` +
            `<td data-label="小計"><span class="cell-val" data-${k}-sum="${item.code}">0</span></td>`;
          host.appendChild(tr);
        });
      }

      function calcAA(){
        let total = 0;
        Object.keys(PRICE.AA).forEach(code=>{
          const qty = N($(`input[data-aa="${code}"]`)?.value);
          const sub = qty * PRICE.AA[code];
          const cell = $(`span[data-aa-sum="${code}"]`);
          if (cell) cell.textContent = F(sub);
          total += sub;
        });
        $('#sumAA').textContent = F(total);
        $('#kpiAA').textContent = F(total);
        $('#resAA').textContent = F(total);
        return total;
      }
      function calcGroup(key, sumId, kpiId, resId){
        let total = 0;
        const k = key.toLowerCase();
        PRICE[key].forEach(item=>{
          const qty = N($(`input[data-${k}="${item.code}"]`)?.value);
          const sub = qty * item.price;
          const cell = $(`span[data-${k}-sum="${item.code}"]`);
          if (cell) cell.textContent = F(sub);
          total += sub;
        });
        $(sumId).textContent = F(total);
        $(kpiId).textContent = F(total);
        $(resId).textContent = F(total);
        return total;
      }
      function updateAll(){
        const sumAA = calcAA();
        const sumBA = calcGroup('BA', '#sumBA', '#kpiBA', '#resBA');
        const sumGA = calcGroup('GA', '#sumGA', '#kpiGA', '#resGA');
        const sumSC = calcGroup('SC', '#sumSC', '#kpiSC', '#resSC');
        const total = sumAA + sumBA + sumGA + sumSC;
        $('#kpiTotal').textContent = F(total);
        $('#resTotal').textContent = F(total);
        const ratioPct = N($('#ratioPct').value) || 0;
        $('#resRatio').textContent = ratioPct;
        const salary = Math.round(total * (ratioPct / 100));
        $('#kpiSalary').textContent = F(salary);
        $('#resSalary').textContent = F(salary);
        syncInsuranceBySalary(salary);
        saveAll();
      }

      function buildInsOptions(){
        const sel = $('#insGrade'); sel.innerHTML = '';
        INS_TABLE.forEach(row=>{
          const opt = document.createElement('option');
          opt.value = row.grade;
          opt.textContent = F(row.grade);
          sel.appendChild(opt);
        });
      }
      function findGradeBySalary(sal){
        for (const v of INS_TABLE){
          if (sal <= v.grade) return v.grade; 
        }
        return INS_TABLE[INS_TABLE.length-1].grade; 
      }
      function getRow(grade){ return INS_TABLE.find(r=>r.grade===grade) || INS_TABLE[0]; }
      function syncInsuranceBySalary(salary){
        const auto = $('#insAuto').checked;
        const sel = $('#insGrade');
        if(auto){
          const autoGrade = findGradeBySalary(salary);
          if (+sel.value !== autoGrade) sel.value = String(autoGrade);
        }
        const row = getRow(+$('#insGrade').value);
        if (auto){
          $('#insLabor').value = row.labor;
          $('#insHealth').value = row.health;
        }
        const insSum = (N($('#insLabor').value)) + (N($('#insHealth').value));
        $('#insSum').textContent = F(insSum);
        $('#kpiIns').textContent = F(insSum);
        const net = Math.max(0, (salary - insSum));
        $('#netPay').textContent = F(net);
        $('#kpiNet').textContent = F(net);
        $('#resNet').textContent = F(net);
      }

      function saveAll(){
        const aa = {}; Object.keys(PRICE.AA).forEach(code=> aa[code]=N($(`input[data-aa="${code}"]`).value)); localStorage.setItem('pl-aa', JSON.stringify(aa));
        ['BA','GA','SC'].forEach(key=>{ const k=key.toLowerCase(); const obj={}; PRICE[key].forEach(item=> obj[item.code]=N($(`input[data-${k}="${item.code}"]`).value)); localStorage.setItem(`pl-${k}`, JSON.stringify(obj)); });
        const params = { month:$('#plMonth').value, ratio:N($('#ratioPct').value), insGrade:N($('#insGrade').value), insLabor:N($('#insLabor').value), insHealth:N($('#insHealth').value), insAuto:$('#insAuto').checked };
        localStorage.setItem('pl-params', JSON.stringify(params));
      }
      function loadLS(key, fb){ try{ return JSON.parse(localStorage.getItem(key)) || fb; }catch(e){ return fb; } }
      function restore(){
        const p = loadLS('pl-params', {});
        $('#plMonth').value = p.month || '';
        $('#ratioPct').value = p.ratio || 60;
        $('#insGrade').value = p.insGrade || INS_TABLE[0].grade;
        $('#insLabor').value = p.insLabor || 0;
        $('#insHealth').value = p.insHealth || 0;
        $('#insAuto').checked = p.insAuto !== false; // Default to true if not set
      }

      function wire(){
        $$('.tbl:not(.insurance-table) input[type="number"]').forEach(inp => inp.addEventListener('input', updateAll));
        $('#ratioPct').addEventListener('input', updateAll);
        $('#plMonth').addEventListener('change', saveAll);
        
        $$('.insurance-table input, .insurance-table select').forEach(el => el.addEventListener('input', () => {
          if (event.target.id !== 'insGrade' && event.target.id !== 'insAuto') $('#insAuto').checked = false;
          syncInsuranceBySalary(N($('#resSalary').textContent.replace(/,/g,'')));
          saveAll();
        }));
        
        $('#btnResetAll').addEventListener('click', ()=>{
          ['pl-aa','pl-ba','pl-ga','pl-sc','pl-params'].forEach(k=>localStorage.removeItem(k));
          location.reload();
        });
        
        $('#btnPrint').addEventListener('click', ()=>window.print());
      }

      buildAA(); buildGroup('tblBA','BA','pl-ba'); buildGroup('tblGA','GA','pl-ga'); buildGroup('tblSC','SC','pl-sc'); buildInsOptions(); restore(); wire(); updateAll();

      document.addEventListener('contextmenu', e => e.preventDefault());
      document.addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && ['u','s','p'].includes(e.key.toLowerCase())) e.preventDefault();
        if (e.key === 'F12') e.preventDefault();
      });
      document.addEventListener('selectstart', e => e.preventDefault());
      document.addEventListener('copy', e => e.preventDefault());
    })();
  </script>
  <!-- PDF 解析區塊 -->
  <script>
    (() => {
      const $ = s => document.querySelector(s);
      const debug = $('#ps-debug'), bar = $('#ps-bar'), statusEl = $('#ps-status');
      const log = s => { if(debug) debug.textContent += (typeof s === 'string' ? s : JSON.stringify(s,null,2))+'\n'; };
      const setBar = p => { if(bar) bar.style.width = `${Math.max(0,Math.min(100,p))}%`; };

      const CODE_ALIAS = {'BA05-1': 'BA05', 'BA05-2': 'BA05', 'BA16-1': 'BA16', 'BA16-2': 'BA16'};
      const toCanon = c => CODE_ALIAS[c] || c;

      let pdfReady=null;
      const loadScript = src => new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;document.head.appendChild(s);});
      async function ensurePdfjs(){
        if(window.pdfjsLib)return; if(pdfReady){await pdfReady;return;}
        pdfReady=(async()=>{ for(const v of ["4.2.67","3.11.174","2.16.105"]){try{await loadScript(`https://cdn.jsdelivr.net/npm/pdfjs-dist@${v}/build/pdf.min.js`);window.pdfjsLib.GlobalWorkerOptions.workerSrc=`https://cdn.jsdelivr.net/npm/pdfjs-dist@${v}/build/pdf.worker.min.js`;return;}catch{}} throw new Error('pdf.js failed');})();
        await pdfReady;
      }

      let ocrReady=null;
      async function ensureTesseract(){
        if(window.Tesseract)return; if(ocrReady){await ocrReady;return;}
        ocrReady=(async()=>{await loadScript('https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js');Tesseract.setLogging(false);})();
        await ocrReady;
      }

      function getAAUnit(){ return { AA05:200, AA06:200, AA07:760, AA08:385, AA09:770, AA11:50 }; }

      async function extractPdfText(file){
        await ensurePdfjs();
        const ab = await file.arrayBuffer();
        const pdf = await window.pdfjsLib.getDocument({data:ab}).promise;
        let texts=[], charCount=0;
        for(let i=1; i<=pdf.numPages; i++){
            const page = await pdf.getPage(i);
            const c = await page.getTextContent();
            const s = c.items.map(it=>it.str).join(' ');
            texts.push(s); charCount+=s.length; setBar(100*i/pdf.numPages);
        }
        return {text:texts.join('\n'), pdf, charCount};
      }
      
      async function analyze(text){
        const units = getAAUnit(), fam = {BA:{},AA:{},GA:{},SC:{}};
        const codeRe = /\b(BA|AA|GA|SC)\d{2}(?:-\d+)?\b/g;
        for (const line of text.split(/\r?\n/)){
            const codes=[...line.matchAll(codeRe)]; if(!codes.length) continue;
            for (const m of codes){
                const canon = toCanon(m[0]);
                const head = canon.slice(0,2);
                fam[head][canon] = fam[head][canon] || {occ:0, sum:0};
                fam[head][canon].occ++;
                if (head==='AA'){
                  const after = line.slice(m.index+m[0].length, m.index+m[0].length+40);
                  const m1 = after.match(/\$\s*([\d,]+)/);
                  const amt = m1 ? parseInt(m1[1].replace(/,/g,''),10) : 0;
                  const u = units[canon];
                  fam.AA[canon].sum += u && amt ? Math.round(amt/u*2)/2 : 0;
                } else { fam[head][canon].sum++; }
            }
        }
        return {
          BA: Object.entries(fam.BA).map(([k,v])=>({code:k,...v})),
          AA: Object.entries(fam.AA).map(([k,v])=>({code:k,...v})),
          GA: Object.entries(fam.GA).map(([k,v])=>({code:k,...v})),
          SC: Object.entries(fam.SC).map(([k,v])=>({code:k,...v})),
        };
      }

      function renderAll(res){
        ['BA','AA','GA','SC'].forEach(k => {
            const tableBody = $(`#ps-t-${k} tbody`);
            if(tableBody) tableBody.innerHTML = res[k].map(r=>`<tr><td><span class="ps-pill">${r.code}</span></td><td class="ps-right">${r.occ}</td><td class="ps-right">${r.sum}</td></tr>`).join('');
        });
      }

      function applyToPayroll(res){
          document.querySelectorAll('.tbl:not(.insurance-table) input[type="number"]').forEach(i=>i.value=0);
          Object.keys(res).forEach(k => {
            res[k].forEach(r => {
                const sel = $(`input[data-${k.toLowerCase()}="${r.code}"]`);
                if(sel) sel.value = r.sum;
            });
          });
          document.querySelector('#tblAA input')?.dispatchEvent(new Event('input', {bubbles:true})); // Trigger update
      }

      let lastResult=null;
      async function handleFile(f){
        debug.textContent='偵錯訊息：\n'; setBar(0); statusEl.textContent='解析中...';
        try{
            let {text} = await extractPdfText(f);
            const res = await analyze(text);
            renderAll(res);
            lastResult = res;
            ['#ps-apply','#ps-csv','#ps-json'].forEach(s=>$(s).disabled=false);
            if($('#ps-auto-sync').checked) applyToPayroll(res); else $('#ps-syncbar').style.display = 'flex';
        } catch(e) { log(e.message); alert('PDF 解析失敗，請確認檔案。');}
        statusEl.textContent='完成';
      }
      
      $('#ps-file').addEventListener('change', e => e.target.files[0] && handleFile(e.target.files[0]));
      $('#ps-demo').addEventListener('click',async () => {
         const d=`嚴X雯 賴X女 2025/09/01 AA05 補助 $100
嚴X雯 王X明 2025/09/03 AA07 補助 $760
嚴X雯 江X輝 2025-09-01 BA07 補助 1 $325
嚴X雯 李OO 2025-09-03 GA09 補助 3`;
        const res = await analyze(d);
        renderAll(res);
        lastResult = res;
        ['#ps-apply','#ps-csv','#ps-json'].forEach(s=>$(s).disabled=false);
      });
      $('#ps-apply').addEventListener('click',()=> lastResult && applyToPayroll(lastResult));
      $('#ps-sync-yes').addEventListener('click',()=>{if (lastResult) applyToPayroll(lastResult); $('#ps-syncbar').style.display = 'none'; });
      $('#ps-sync-no').addEventListener('click',()=> $('#ps-syncbar').style.display = 'none');
    })();
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const config = {
      apiKey: "AIzaSyCZMhdUI0HeIoj5masuRh00pzP3SMbF6Yc",
      authDomain: "hori-test-1b93c.firebaseapp.com",
      projectId: "hori-test-1b93c",
      storageBucket: "hori-test-1b93c.firebasestorage.app",
      messagingSenderId: "549583061796",
      appId: "1:549583061796:web:ad58b8bf80c2b6b71c29b1"
    };

    const app = initializeApp(config);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const dom = {
        login: document.getElementById('btnLogin'),
        logout: document.getElementById('btnLogout'),
        member: document.getElementById('member-area'),
        user: document.getElementById('userDisplay'),
        admin: document.getElementById('btnAdminLink'),
        edit: document.getElementById('btnEditProfile'),
        modal: document.getElementById('profile-modal'),
        save: document.getElementById('btn-save-profile'),
        name: document.getElementById('pf-name'),
        age: document.getElementById('pf-age'),
        title: document.querySelector('#profile-modal h3')
    };

    if(dom.login) {
        dom.login.addEventListener('click', () => {
          signInWithPopup(auth, provider).catch(error => {
              if (error.code === 'auth/popup-blocked') {
                  alert("⚠️ 登入視窗被攔截！請使用 Safari/Chrome 等瀏覽器開啟。");
              } else {
                  alert("登入失敗：" + error.message);
              }
          });
        });
    }

    if(dom.logout) dom.logout.addEventListener('click', () => signOut(auth).then(() => { alert("已登出"); location.reload(); }));

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        if(dom.login) dom.login.style.display = 'none';
        if(dom.member) dom.member.style.display = 'flex';
        if(dom.user) dom.user.textContent = user.displayName || user.email;

        try {
          const docSnap = await getDoc(doc(db, "users", user.uid));
          if (docSnap.exists() && docSnap.data().name) {
             if(dom.user) dom.user.textContent = docSnap.data().name;
          } else {
             if(dom.title) dom.title.textContent = "歡迎加入！請完善資料";
             if(dom.name) dom.name.value = user.displayName || "";
             if(dom.modal) dom.modal.style.display = 'flex';
          }
        } catch(e) { console.error("Firestore read failed:", e); }

        try {
          const adminSnap = await getDoc(doc(db, "admins", user.email));
          if (adminSnap.exists() && dom.admin) dom.admin.style.display = 'inline-block';
        } catch(e) {}
      } else {
        if(dom.login) dom.login.style.display = 'block';
        if(dom.member) dom.member.style.display = 'none';
        if(dom.admin) dom.admin.style.display = 'none';
      }
    });

    if(dom.edit) dom.edit.addEventListener('click', async () => {
      const userRef = doc(db, "users", auth.currentUser.uid);
      const docSnap = await getDoc(userRef);
      if(docSnap.exists()){
        const d = docSnap.data();
        dom.title.textContent = "修改個人資料";
        dom.name.value = d.name || "";
        dom.age.value = d.age || "";
        dom.modal.style.display = 'flex';
      }
    });

    if(dom.save) dom.save.addEventListener('click', async () => {
      const name = dom.name.value.trim();
      const age = dom.age.value.trim();
      if(!name || !age) return alert("請填寫完整");
      
      const userRef = doc(db, "users", auth.currentUser.uid);
      try {
          let data = { name, age, email: auth.currentUser.email, lastUpdated: serverTimestamp() };
          const docSnap = await getDoc(userRef);
          if (!docSnap.exists() || !docSnap.data().createdAt) {
              data.createdAt = serverTimestamp();
          }
          await setDoc(userRef, data, { merge: true });
          alert("儲存成功");
          if(dom.modal) dom.modal.style.display = 'none';
          if(dom.user) dom.user.textContent = name;
      } catch (e) { alert("儲存失敗：" + e.message); }
    });

    if(dom.modal) dom.modal.addEventListener('click', (e) => {
      if (e.target === dom.modal) {
        // 新註冊用戶（還未儲存過資料）時不允許關閉
        getDoc(doc(db, "users", auth.currentUser.uid)).then(docSnap => {
          if (docSnap.exists()) {
             dom.modal.style.display = 'none';
          }
        });
      }
    });
  </script>
</body>
</html>
